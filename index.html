<!DOCTYPE html>
<html lang="ru" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Исламский Калькулятор Наследства - образовательный инструмент для расчета долей наследства согласно шариату"
    />
    <meta name="theme-color" content="#1a5f4a" />
    <link rel="icon" type="image/png" href="assets/logo/logo_and_favicon.png" />
    <link rel="apple-touch-icon" href="assets/logo/logo_and_favicon.png" />
    <title>Исламский Калькулятор Наследства 2.0</title>

    <style>
      /* ========================================
         CSS Variables - Цветовая схема
         ======================================== */
      :root {
        /* Основные цвета - спокойная исламская эстетика */
        --color-primary: #1a5f4a;
        --color-primary-light: #2d8a6e;
        --color-primary-dark: #0f3d2f;
        --color-secondary: #c9a227;
        --color-secondary-light: #e6c04a;

        /* Нейтральные цвета */
        --color-bg: #faf9f7;
        --color-bg-alt: #f5f3ef;
        --color-surface: #ffffff;
        --color-border: #e0ddd5;
        --color-border-light: #eae8e3;

        /* Текст */
        --color-text: #2c2c2c;
        --color-text-secondary: #5a5a5a;
        --color-text-muted: #8a8a8a;
        --color-text-inverse: #ffffff;

        /* Состояния */
        --color-success: #2e7d32;
        --color-warning: #ed6c02;
        --color-error: #d32f2f;
        --color-info: #0288d1;

        /* Тени */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);

        /* Типографика */
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        --font-family-arabic: "Amiri", "Traditional Arabic", serif;

        --font-size-xs: 0.75rem;
        --font-size-sm: 0.875rem;
        --font-size-base: 1rem;
        --font-size-lg: 1.125rem;
        --font-size-xl: 1.25rem;
        --font-size-2xl: 1.5rem;
        --font-size-3xl: 1.875rem;
        --font-size-4xl: 2.25rem;

        --line-height-tight: 1.25;
        --line-height-normal: 1.5;
        --line-height-relaxed: 1.75;

        /* Отступы */
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        --spacing-2xl: 3rem;
        --spacing-3xl: 4rem;

        /* Радиусы */
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;
        --radius-full: 9999px;

        /* Переходы */
        --transition-fast: 150ms ease;
        --transition-normal: 250ms ease;
        --transition-slow: 350ms ease;

        /* Контейнер */
        --container-max-width: 900px;
        --container-padding: var(--spacing-md);
      }

      /* ========================================
         CSS Reset
         ======================================== */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html {
        font-size: 16px;
        -webkit-text-size-adjust: 100%;
        scroll-behavior: smooth;
      }

      body {
        font-family: var(--font-family);
        font-size: var(--font-size-base);
        line-height: var(--line-height-normal);
        color: var(--color-text);
        background-color: var(--color-bg);
        min-height: 100vh;
      }

      img,
      picture,
      video,
      canvas,
      svg {
        display: block;
        max-width: 100%;
      }

      input,
      button,
      textarea,
      select {
        font: inherit;
      }

      button {
        cursor: pointer;
        border: none;
        background: none;
      }

      a {
        color: var(--color-primary);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      ul,
      ol {
        list-style: none;
      }

      table {
        border-collapse: collapse;
        width: 100%;
      }

      /* ========================================
         Базовые стили элементов
         ======================================== */

      /* Контейнер */
      .container {
        width: 100%;
        max-width: var(--container-max-width);
        margin: 0 auto;
        padding: 0 var(--container-padding);
      }

      /* Заголовки */
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-weight: 600;
        line-height: var(--line-height-tight);
        color: var(--color-text);
      }

      h1 {
        font-size: var(--font-size-3xl);
      }
      h2 {
        font-size: var(--font-size-2xl);
      }
      h3 {
        font-size: var(--font-size-xl);
      }
      h4 {
        font-size: var(--font-size-lg);
      }

      .section-title {
        font-size: var(--font-size-2xl);
        margin-bottom: var(--spacing-lg);
        color: var(--color-primary-dark);
        text-align: center;
      }

      /* Скрытие элементов */
      .hidden {
        display: none !important;
      }

      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* Print-only elements (hidden by default, shown only in print) */
      .print-only {
        display: none;
      }

      /* ========================================
         Header
         ======================================== */
      .header {
        background: linear-gradient(
          135deg,
          var(--color-primary) 0%,
          var(--color-primary-dark) 100%
        );
        color: var(--color-text-inverse);
        padding: var(--spacing-xl) 0;
        text-align: center;
      }

      .header__title {
        font-size: var(--font-size-2xl);
        margin-bottom: var(--spacing-sm);
        color: var(--color-text-inverse);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
      }

      .header__logo {
        width: 64px;
        height: auto;
        border-radius: 8px;
        object-fit: contain;
        flex-shrink: 0;
      }

      .header__text {
        text-align: center;
      }

      .header__subtitle {
        font-size: var(--font-size-base);
        opacity: 0.9;
      }

      /* ========================================
         Modal (using dialog element)
         ======================================== */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
        border: none;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-md);
        z-index: 1000;
        overflow-y: auto;
      }

      .modal[open] {
        display: flex;
      }

      .modal::backdrop {
        background-color: rgba(0, 0, 0, 0.6);
      }

      .modal__content {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
      }

      .modal__title {
        font-size: var(--font-size-xl);
        color: var(--color-primary-dark);
        margin-bottom: var(--spacing-md);
        text-align: center;
      }

      .modal__description {
        color: var(--color-text-secondary);
        margin-bottom: var(--spacing-lg);
        text-align: center;
      }

      .modal__notice {
        background-color: var(--color-bg-alt);
        border-left: 4px solid var(--color-secondary);
        padding: var(--spacing-md);
        margin: var(--spacing-lg) 0;
        border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      }

      .modal__notice p {
        margin-bottom: var(--spacing-xs);
      }

      .modal__notice p:last-child {
        margin-bottom: 0;
      }

      .modal__confirmation {
        margin: var(--spacing-md) 0;
      }

      /* Список обязательств */
      .obligations-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .obligations-list__item {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background-color: var(--color-bg-alt);
        border-radius: var(--radius-md);
      }

      .obligations-list__icon {
        font-size: 1.5rem;
        flex-shrink: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .obligations-list__content {
        flex: 1;
      }

      .obligations-list__content strong {
        display: block;
        font-size: var(--font-size-sm);
        color: var(--color-primary-dark);
      }

      .obligations-list__content p {
        font-size: var(--font-size-xs);
        color: var(--color-text-secondary);
        margin-top: 2px;
      }

      /* ========================================
         Buttons
         ======================================== */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-lg);
        font-size: var(--font-size-base);
        font-weight: 500;
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
        min-height: 44px;
        min-width: 44px;
      }

      .btn--primary {
        background-color: var(--color-primary);
        color: var(--color-text-inverse);
      }

      .btn--primary:hover:not(:disabled) {
        background-color: var(--color-primary-light);
      }

      .btn--primary:disabled {
        background-color: var(--color-border);
        color: var(--color-text-muted);
        cursor: not-allowed;
      }

      .btn--secondary {
        background-color: var(--color-secondary);
        color: var(--color-text);
      }

      .btn--secondary:hover {
        background-color: var(--color-secondary-light);
      }

      .btn--outline {
        background-color: transparent;
        border: 2px solid var(--color-primary);
        color: var(--color-primary);
      }

      .btn--outline:hover {
        background-color: var(--color-primary);
        color: var(--color-text-inverse);
      }

      .btn--large {
        padding: var(--spacing-md) var(--spacing-xl);
        font-size: var(--font-size-lg);
      }

      /* ========================================
         Form Elements
         ======================================== */
      .form-group {
        margin-bottom: var(--spacing-md);
      }

      .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: var(--spacing-xs);
        color: var(--color-text);
      }

      .form-input {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: var(--font-size-base);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-md);
        background-color: var(--color-surface);
        transition: border-color var(--transition-fast),
          box-shadow var(--transition-fast);
        min-height: 44px;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(26, 95, 74, 0.1);
        animation: pulse 0.3s ease;
      }

      .form-input:disabled {
        background-color: var(--color-bg-alt);
        color: var(--color-text-muted);
        cursor: not-allowed;
      }

      .form-input--small {
        max-width: 120px;
      }

      .form-hint {
        display: block;
        font-size: var(--font-size-sm);
        color: var(--color-text-muted);
        margin-top: var(--spacing-xs);
      }

      .form-error {
        display: block;
        font-size: var(--font-size-sm);
        color: var(--color-error);
        margin-top: var(--spacing-xs);
      }

      .blocked-hint {
        color: var(--color-warning);
        font-style: italic;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
      }

      .form-section {
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-md);
        background-color: var(--color-bg-alt);
        border-radius: var(--radius-md);
      }

      .form-section__title {
        font-size: var(--font-size-lg);
        margin-bottom: var(--spacing-md);
        color: var(--color-primary-dark);
      }

      .form-subsection-title {
        font-size: var(--font-size-base);
        font-weight: 500;
        margin: var(--spacing-md) 0 var(--spacing-sm);
        color: var(--color-text-secondary);
        border-bottom: 1px solid var(--color-border-light);
        padding-bottom: var(--spacing-xs);
      }

      .form-actions {
        margin-top: var(--spacing-xl);
        text-align: center;
      }

      /* Radio и Checkbox */
      .radio-group,
      .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .radio,
      .checkbox {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        cursor: pointer;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        transition: background-color var(--transition-fast);
        min-height: 44px;
      }

      .radio:hover,
      .checkbox:hover {
        background-color: var(--color-bg-alt);
      }

      .radio input,
      .checkbox input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }

      .radio__mark,
      .checkbox__mark {
        width: 20px;
        height: 20px;
        border: 2px solid var(--color-border);
        background-color: var(--color-surface);
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--transition-fast);
      }

      .radio__mark {
        border-radius: 50%;
      }

      .checkbox__mark {
        border-radius: var(--radius-sm);
      }

      .radio input:checked + .radio__mark,
      .checkbox input:checked + .checkbox__mark {
        border-color: var(--color-primary);
        background-color: var(--color-primary);
      }

      .radio input:checked + .radio__mark::after {
        content: "";
        width: 8px;
        height: 8px;
        background-color: var(--color-text-inverse);
        border-radius: 50%;
      }

      .checkbox input:checked + .checkbox__mark::after {
        content: "✓";
        color: var(--color-text-inverse);
        font-size: var(--font-size-sm);
        font-weight: bold;
      }

      .radio__label,
      .checkbox__label {
        flex: 1;
      }

      /* ========================================
         Collapsible Sections
         ======================================== */
      .collapsible-section {
        margin-bottom: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        background-color: var(--color-surface);
      }

      .collapsible-section__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-md);
        cursor: pointer;
        min-height: 44px;
        list-style: none;
      }

      .collapsible-section__header::-webkit-details-marker {
        display: none;
      }

      .collapsible-section__title {
        font-weight: 500;
        color: var(--color-primary-dark);
      }

      .collapsible-section__icon {
        transition: transform var(--transition-fast);
        color: var(--color-text-muted);
      }

      .collapsible-section[open] .collapsible-section__icon {
        transform: rotate(180deg);
      }

      .collapsible-section__content {
        padding: 0 var(--spacing-md) var(--spacing-md);
        overflow: hidden;
        transition: max-height var(--transition-normal) ease;
      }

      /* ========================================
         Main Content
         ======================================== */
      .main {
        padding: var(--spacing-xl) 0;
      }

      .wizard-step {
        display: none;
        opacity: 0;
        transition: opacity var(--transition-normal) ease;
      }

      .wizard-step.active {
        display: block;
        opacity: 1;
      }

      /* ========================================
         Results Section
         ======================================== */
      .results-section {
        padding: var(--spacing-xl) 0;
        background-color: var(--color-bg-alt);
        transition: opacity var(--transition-normal) ease;
      }

      .results-section.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .notices {
        margin-bottom: var(--spacing-lg);
      }

      .notice {
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-sm);
        animation: fadeIn var(--transition-normal) ease-out forwards;
      }

      .notice--warning {
        background-color: #fff3e0;
        border-left: 4px solid var(--color-warning);
      }

      .notice--info {
        background-color: #e3f2fd;
        border-left: 4px solid var(--color-info);
      }

      .notice__icon {
        font-size: var(--font-size-xl);
        flex-shrink: 0;
      }

      .results-table-wrapper {
        overflow-x: auto;
        margin-bottom: var(--spacing-lg);
      }

      .results-table {
        background-color: var(--color-surface);
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-md);
      }

      .results-table th,
      .results-table td {
        padding: var(--spacing-sm) var(--spacing-md);
        text-align: left;
        border-bottom: 1px solid var(--color-border-light);
      }

      .results-table th {
        background-color: var(--color-primary);
        color: var(--color-text-inverse);
        font-weight: 500;
      }

      .results-table tbody tr:hover {
        background-color: var(--color-bg-alt);
      }

      .results-table tfoot {
        background-color: var(--color-bg-alt);
        font-weight: 600;
      }

      .results-total td {
        border-top: 2px solid var(--color-primary);
      }

      .results-total td#total-percentage {
        white-space: nowrap;
      }

      /* Стили для индикатора 100% распределения */
      .total-valid {
        color: var(--color-success);
        font-weight: 600;
      }

      .total-warning {
        color: var(--color-warning);
        font-weight: 600;
      }

      /* Стили для заблокированных наследников */
      .blocked-heir {
        opacity: 0.6;
        background-color: var(--color-bg-alt);
      }

      .blocking-info td {
        padding: var(--spacing-xs) var(--spacing-md);
        font-style: italic;
        color: var(--color-warning);
        border-bottom: none;
      }

      .dalil-cell {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        max-width: 200px;
      }

      .results-cards {
        display: none;
      }

      .results-card__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
        padding-bottom: var(--spacing-sm);
        border-bottom: 1px solid var(--color-border-light);
      }

      .results-card__name {
        font-weight: 600;
        color: var(--color-primary-dark);
      }

      .results-card__amount {
        font-weight: 600;
        color: var(--color-secondary);
      }

      .results-card__details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-xs);
        font-size: var(--font-size-sm);
      }

      .results-card__detail {
        display: flex;
        justify-content: space-between;
      }

      .results-card__label {
        color: var(--color-text-muted);
      }

      .results-card__dalil {
        margin-top: var(--spacing-sm);
        padding-top: var(--spacing-sm);
        border-top: 1px solid var(--color-border-light);
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
      }

      .results-card__blocking {
        margin-top: var(--spacing-sm);
        padding-top: var(--spacing-sm);
        border-top: 1px solid var(--color-border-light);
        font-size: var(--font-size-sm);
      }

      .results-card.blocked-heir {
        opacity: 0.6;
        background-color: var(--color-bg-alt);
        border-left: 3px solid var(--color-warning);
      }

      .results-card--total {
        background-color: var(--color-bg-alt);
        border: 2px solid var(--color-primary);
        border-left: 4px solid var(--color-primary);
      }

      .results-card--total .results-card__name,
      .results-card--total .results-card__amount {
        color: var(--color-primary-dark);
        font-size: var(--font-size-lg);
      }

      .results-card--total .results-card__label {
        color: var(--color-text-secondary);
      }

      /* Индикаторы для процента - без переноса */
      .total-valid,
      .total-warning {
        white-space: nowrap;
      }

      .results-actions {
        display: flex;
        gap: var(--spacing-md);
        justify-content: center;
        flex-wrap: wrap;
      }

      /* ========================================
         Glossary Section
         ======================================== */
      .glossary-section {
        padding: var(--spacing-xl) 0;
        background-color: var(--color-surface);
      }

      .glossary-grid {
        display: grid;
        gap: var(--spacing-md);
      }

      .glossary-item {
        padding: var(--spacing-md);
        background-color: var(--color-bg-alt);
        border-radius: var(--radius-md);
        border-left: 4px solid var(--color-primary);
      }

      .glossary-term {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
      }

      .glossary-term__ar {
        font-family: var(--font-family-arabic);
        font-size: var(--font-size-xl);
        color: var(--color-primary);
        direction: rtl;
      }

      .glossary-term__ru {
        font-weight: 600;
        color: var(--color-primary-dark);
      }

      .glossary-definition {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        line-height: var(--line-height-relaxed);
      }

      /* ========================================
         Tooltip Styles
         ======================================== */
      .tooltip {
        position: relative;
        cursor: help;
        border-bottom: 1px dotted var(--color-primary);
      }

      .tooltip::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--color-primary-dark);
        color: var(--color-text-inverse);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        line-height: var(--line-height-normal);
        white-space: nowrap;
        max-width: 300px;
        white-space: normal;
        text-align: center;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity var(--transition-fast),
          visibility var(--transition-fast);
        pointer-events: none;
        margin-bottom: var(--spacing-xs);
      }

      .tooltip::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: var(--color-primary-dark);
        margin-bottom: calc(var(--spacing-xs) - 5px);
        opacity: 0;
        visibility: hidden;
        transition: opacity var(--transition-fast),
          visibility var(--transition-fast);
      }

      .tooltip:hover::before,
      .tooltip:hover::after,
      .tooltip.tooltip-active::before,
      .tooltip.tooltip-active::after {
        opacity: 1;
        visibility: visible;
      }

      /* Touch device specific styles */
      @media (hover: none) and (pointer: coarse) {
        .tooltip {
          border-bottom: 2px dotted var(--color-primary);
        }

        .tooltip::before {
          font-size: var(--font-size-sm);
          padding: var(--spacing-sm);
          max-width: 280px;
        }
      }

      /* Mobile tooltip adjustments */
      @media screen and (max-width: 767px) {
        .tooltip {
          position: relative;
        }

        .tooltip::before {
          position: fixed;
          z-index: 9999;
          max-width: calc(100vw - 2rem);
          font-size: var(--font-size-xs);
          padding: var(--spacing-xs) var(--spacing-sm);
          left: 50%;
          transform: translateX(-50%);
          bottom: 100%;
          margin-bottom: var(--spacing-xs);
          word-wrap: break-word;
          white-space: normal;
        }

        .tooltip::after {
          left: 50%;
          transform: translateX(-50%);
        }
      }

      /* ========================================
         FAQ Section
         ======================================== */
      .faq-section {
        padding: var(--spacing-xl) 0;
        background-color: var(--color-bg-alt);
      }

      .faq-accordion {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .faq-item {
        background-color: var(--color-surface);
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
      }

      .faq-question {
        padding: var(--spacing-md);
        padding-right: calc(var(--spacing-md) + 28px);
        padding-left: calc(var(--spacing-md) * 2);
        cursor: pointer;
        font-weight: 500;
        color: var(--color-primary-dark);
        list-style: none;
        position: relative;
        min-height: 44px;
        display: flex;
        align-items: center;
      }

      .faq-question::-webkit-details-marker {
        display: none;
      }

      .faq-question::after {
        content: "+";
        font-size: var(--font-size-xl);
        color: var(--color-primary);
        transition: transform var(--transition-fast);
        position: absolute;
        right: var(--spacing-md);
        top: 50%;
        transform: translateY(-50%);
      }

      .faq-item[open] .faq-question::after {
        content: "−";
      }

      .faq-answer {
        padding: 0 var(--spacing-md) var(--spacing-md);
        color: var(--color-text-secondary);
        line-height: var(--line-height-relaxed);
      }

      .faq-answer p {
        margin-bottom: var(--spacing-sm);
      }

      .faq-answer p:last-child {
        margin-bottom: 0;
      }

      /* ========================================
         Footer
         ======================================== */
      .footer {
        background-color: var(--color-primary-dark);
        color: var(--color-text-inverse);
        padding: var(--spacing-xl) 0;
      }

      .disclaimer {
        background-color: rgba(255, 255, 255, 0.1);
        padding: var(--spacing-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
      }

      .disclaimer__title {
        font-size: var(--font-size-lg);
        margin-bottom: var(--spacing-sm);
        color: var(--color-secondary-light);
      }

      .disclaimer__text {
        font-size: var(--font-size-sm);
        opacity: 0.9;
        margin-bottom: var(--spacing-sm);
      }

      .disclaimer__text:last-child {
        margin-bottom: 0;
      }

      .footer__copyright {
        text-align: center;
        font-size: var(--font-size-sm);
        opacity: 0.7;
      }

      /* ========================================
         Print Styles
         ======================================== */
      @media print {
        /* Hide non-essential elements for print */
        .modal,
        .header,
        .form-actions,
        .results-actions,
        .faq-section,
        .btn,
        .glossary-section {
          display: none !important;
        }

        /* Show only results section and footer */
        .results-section {
          display: block !important;
          background: none !important;
          padding: 20px 0 !important;
          box-shadow: none !important;
        }

        /* Print-only elements */
        .print-only {
          display: block !important;
        }

        /* Hide mobile cards, show table */
        .results-cards {
          display: none !important;
        }

        .results-table-wrapper {
          display: block !important;
          overflow: visible !important;
        }

        /* Table styling for print */
        .results-table {
          box-shadow: none !important;
          border: 2px solid #000 !important;
          width: 100% !important;
          font-size: 12px !important;
        }

        .results-table th,
        .results-table td {
          border: 1px solid #000 !important;
          padding: 8px 4px !important;
          font-size: 11px !important;
        }

        .results-table th {
          background-color: #f0f0f0 !important;
          color: #000 !important;
          font-weight: bold !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        /* Notices styling for print */
        .notices {
          margin-bottom: 20px !important;
        }

        .notice {
          border: 1px solid #000 !important;
          padding: 10px !important;
          margin-bottom: 10px !important;
          background: none !important;
          page-break-inside: avoid !important;
        }

        .notice--warning {
          border-left: 4px solid #000 !important;
        }

        .notice--info {
          border-left: 4px solid #666 !important;
        }

        /* Footer and disclaimer for print */
        .footer {
          background: none !important;
          color: #000 !important;
          border-top: 2px solid #000 !important;
          padding: 20px 0 !important;
          margin-top: 30px !important;
          page-break-inside: avoid !important;
        }

        .disclaimer {
          background: none !important;
          border: 2px solid #000 !important;
          color: #000 !important;
          padding: 15px !important;
          margin-bottom: 15px !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .disclaimer__title {
          color: #000 !important;
          font-size: 14px !important;
          margin-bottom: 10px !important;
        }

        .disclaimer__text {
          font-size: 11px !important;
          line-height: 1.4 !important;
          margin-bottom: 8px !important;
          opacity: 1 !important;
        }

        .footer__copyright {
          text-align: center !important;
          font-size: 10px !important;
          opacity: 1 !important;
          color: #000 !important;
        }

        /* Page settings */
        @page {
          margin: 2cm;
          size: A4;
        }

        /* Prevent page breaks in important sections */
        .results-table,
        .disclaimer {
          page-break-inside: avoid;
        }

        /* Ensure proper text color for print */
        * {
          color: #000 !important;
          background: transparent !important;
        }

        /* Special styling for blocked heirs in print */
        .blocked-heir {
          opacity: 0.7 !important;
          font-style: italic !important;
        }

        .blocking-info td {
          font-size: 10px !important;
          font-style: italic !important;
        }

        /* Print header with calculator title */
        .results-section::before {
          content: "☪️ Исламский Калькулятор Наследства - Результаты расчета";
          display: block !important;
          text-align: center !important;
          font-size: 18px !important;
          font-weight: bold !important;
          margin-bottom: 20px !important;
          padding-bottom: 10px !important;
          border-bottom: 2px solid #000 !important;
        }
      }

      /* ========================================
         Responsive Styles - Mobile First
         ======================================== */

      /* Base mobile styles (320px+) */
      @media screen and (max-width: 767px) {
        :root {
          --container-padding: var(--spacing-sm);
        }

        .header {
          padding: var(--spacing-md) 0;
        }

        .header__title {
          font-size: var(--font-size-lg);
          flex-direction: column;
          gap: var(--spacing-xs);
          line-height: 1.3;
        }

        .header__logo {
          width: 56px;
          height: 56px;
        }

        .header__subtitle {
          font-size: var(--font-size-sm);
          padding: 0 var(--spacing-sm);
        }

        .section-title {
          font-size: var(--font-size-xl);
        }

        /* Modal adjustments */
        .modal {
          padding: var(--spacing-sm);
          align-items: flex-start;
          padding-top: var(--spacing-lg);
        }

        .modal__content {
          padding: var(--spacing-md);
          max-height: none;
          margin: 0;
          width: calc(100% - var(--spacing-md));
        }

        .modal__title {
          font-size: var(--font-size-lg);
        }

        .obligations-list__item {
          padding: var(--spacing-sm);
          flex-direction: row;
          text-align: left;
          gap: var(--spacing-sm);
        }

        .obligations-list__icon {
          font-size: var(--font-size-xl);
        }

        /* Form adjustments */
        .form-grid {
          grid-template-columns: 1fr;
          gap: var(--spacing-sm);
        }

        .form-input--small {
          max-width: 100%;
        }

        .form-section {
          padding: var(--spacing-sm);
          margin-bottom: var(--spacing-md);
        }

        .form-section__title {
          font-size: var(--font-size-base);
        }

        /* Collapsible sections mobile optimization */
        .collapsible-section__header {
          padding: var(--spacing-sm);
        }

        .collapsible-section__content {
          padding: var(--spacing-sm);
        }

        /* Results - show cards instead of table */
        .results-table-wrapper {
          display: none;
        }

        .results-cards {
          display: block;
        }

        .results-card__details {
          grid-template-columns: 1fr;
        }

        /* Glossary */
        .glossary-term {
          flex-direction: column;
          align-items: flex-start;
          gap: var(--spacing-xs);
        }

        .glossary-grid {
          grid-template-columns: 1fr;
          gap: var(--spacing-sm);
        }

        /* FAQ */
        .faq-question {
          font-size: var(--font-size-sm);
          padding: var(--spacing-sm);
          padding-right: calc(var(--spacing-sm) + 26px);
          padding-left: calc(var(--spacing-sm) * 2);
        }

        .faq-answer {
          padding: 0 var(--spacing-sm) var(--spacing-sm);
          font-size: var(--font-size-sm);
        }

        /* Footer */
        .disclaimer {
          padding: var(--spacing-md);
        }

        .disclaimer__title {
          font-size: var(--font-size-base);
        }

        /* Buttons */
        .btn--large {
          width: 100%;
          padding: var(--spacing-md);
        }

        .results-actions {
          flex-direction: column;
          gap: var(--spacing-sm);
        }

        .results-actions .btn {
          width: 100%;
        }

        /* Improved spacing for mobile */
        .main {
          padding: var(--spacing-md) 0;
        }

        .results-section {
          padding: var(--spacing-md) 0;
        }

        .glossary-section {
          padding: var(--spacing-md) 0;
        }

        .faq-section {
          padding: var(--spacing-md) 0;
        }

        /* Better mobile typography */
        .form-label {
          font-size: var(--font-size-sm);
          font-weight: 600;
        }

        .form-hint {
          font-size: var(--font-size-xs);
        }
      }

      /* Tablet styles (768px+) */
      @media screen and (min-width: 768px) {
        :root {
          --container-padding: var(--spacing-lg);
        }

        .header {
          padding: var(--spacing-2xl) 0;
        }

        .header__title {
          font-size: var(--font-size-3xl);
        }

        .modal__content {
          padding: var(--spacing-xl);
        }

        .glossary-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .radio-group {
          flex-direction: row;
          flex-wrap: wrap;
        }

        .radio {
          flex: 0 0 auto;
        }
      }

      /* Desktop styles (1024px+) */
      @media screen and (min-width: 1024px) {
        :root {
          --container-max-width: 1000px;
        }

        .header__title {
          font-size: var(--font-size-4xl);
        }

        .section-title {
          font-size: var(--font-size-3xl);
        }

        .glossary-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .results-table th,
        .results-table td {
          padding: var(--spacing-md);
        }
      }

      /* Extra small mobile screens (320px-479px) */
      @media screen and (max-width: 479px) {
        :root {
          --container-padding: var(--spacing-xs);
          --font-size-base: 0.9rem;
        }

        .header {
          padding: var(--spacing-sm) 0;
        }

        .header__title {
          font-size: var(--font-size-base);
          flex-direction: column;
          gap: var(--spacing-xs);
        }

        .header__logo {
          width: 48px;
          height: 48px;
        }

        .header__subtitle {
          font-size: var(--font-size-xs);
          padding: 0 var(--spacing-xs);
        }

        .section-title {
          font-size: var(--font-size-lg);
          margin-bottom: var(--spacing-md);
        }

        .modal__content {
          padding: var(--spacing-sm);
          width: calc(100% - var(--spacing-xs));
        }

        .modal__title {
          font-size: var(--font-size-base);
        }

        .obligations-list__item {
          padding: var(--spacing-xs);
          flex-direction: row;
          text-align: left;
          gap: var(--spacing-xs);
        }

        .obligations-list__icon {
          font-size: var(--font-size-lg);
        }

        .form-section {
          padding: var(--spacing-xs);
          margin-bottom: var(--spacing-sm);
        }

        .form-section__title {
          font-size: var(--font-size-sm);
        }

        .form-label {
          font-size: var(--font-size-xs);
        }

        .form-input {
          padding: var(--spacing-xs) var(--spacing-sm);
          font-size: var(--font-size-sm);
        }

        .btn {
          padding: var(--spacing-xs) var(--spacing-sm);
          font-size: var(--font-size-sm);
        }

        .btn--large {
          padding: var(--spacing-sm) var(--spacing-md);
        }

        .results-card {
          padding: var(--spacing-sm);
          margin-bottom: var(--spacing-sm);
        }

        .results-card__header {
          margin-bottom: var(--spacing-xs);
        }

        .results-card__name {
          font-size: var(--font-size-sm);
        }

        .results-card__amount {
          font-size: var(--font-size-sm);
        }

        .glossary-item {
          padding: var(--spacing-sm);
        }

        .glossary-term__ar {
          font-size: var(--font-size-lg);
        }

        .glossary-term__ru {
          font-size: var(--font-size-sm);
        }

        .glossary-definition {
          font-size: var(--font-size-xs);
        }

        .faq-question {
          padding: var(--spacing-xs);
          padding-right: calc(var(--spacing-xs) + 24px);
          padding-left: calc(var(--spacing-xs) * 2);
          font-size: var(--font-size-xs);
        }

        .faq-answer {
          padding: 0 var(--spacing-xs) var(--spacing-xs);
          font-size: var(--font-size-xs);
        }

        .disclaimer {
          padding: var(--spacing-sm);
        }

        .disclaimer__title {
          font-size: var(--font-size-sm);
        }

        .disclaimer__text {
          font-size: var(--font-size-xs);
        }
      }

      /* Touch-friendly enhancements */
      @media (hover: none) and (pointer: coarse) {
        .btn,
        .radio,
        .checkbox,
        .collapsible-section__header,
        .faq-question {
          min-height: 48px;
        }

        .form-input {
          min-height: 48px;
          font-size: 16px; /* Prevents zoom on iOS */
          padding: var(--spacing-md);
        }

        /* Larger touch targets */
        .radio__mark,
        .checkbox__mark {
          width: 24px;
          height: 24px;
        }

        .radio input:checked + .radio__mark::after {
          width: 10px;
          height: 10px;
        }

        /* Better touch spacing for form elements */
        .form-group {
          margin-bottom: var(--spacing-lg);
        }

        .radio,
        .checkbox {
          padding: var(--spacing-md);
          margin-bottom: var(--spacing-xs);
        }

        /* Improved modal touch interaction */
        .modal__content {
          padding: var(--spacing-lg);
          margin: var(--spacing-md);
        }

        /* Better tooltip interaction on touch */
        .tooltip {
          border-bottom: 2px solid var(--color-primary);
          padding: var(--spacing-xs) 0;
        }
      }

      /* High contrast mode support */
      @media (prefers-contrast: high) {
        :root {
          --color-border: #000;
          --color-text-muted: #333;
        }

        .btn--primary {
          border: 2px solid var(--color-text-inverse);
        }

        .form-input {
          border-width: 3px;
        }
      }

      /* Reduced motion support */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }

        html {
          scroll-behavior: auto;
        }
      }

      /* Mobile landscape orientation */
      @media screen and (max-width: 767px) and (orientation: landscape) {
        .modal {
          padding: var(--spacing-xs);
          padding-top: var(--spacing-sm);
        }

        .modal__content {
          max-height: 85vh;
          overflow-y: auto;
          padding: var(--spacing-sm);
        }

        .header {
          padding: var(--spacing-sm) 0;
        }

        .main {
          padding: var(--spacing-sm) 0;
        }

        .results-section {
          padding: var(--spacing-sm) 0;
        }

        .form-section {
          margin-bottom: var(--spacing-sm);
        }

        .obligations-list__item {
          flex-direction: row;
          text-align: left;
          padding: var(--spacing-xs);
        }
      }

      /* iOS Safari specific fixes */
      @supports (-webkit-touch-callout: none) {
        .form-input {
          font-size: 16px; /* Prevents zoom on iOS */
          -webkit-appearance: none;
          appearance: none;
          border-radius: var(--radius-md);
        }

        .btn {
          -webkit-appearance: none;
          appearance: none;
          border-radius: var(--radius-md);
        }

        /* Fix for iOS Safari viewport height issues */
        .modal {
          height: 100vh;
          height: -webkit-fill-available;
        }
      }

      /* ========================================
         Animations for smooth transitions
         ======================================== */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-10px);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      .fade-in {
        animation: fadeIn var(--transition-normal) ease-out forwards;
      }

      .fade-out {
        animation: fadeOut var(--transition-fast) ease-in forwards;
      }

      .slide-in {
        animation: slideIn var(--transition-normal) ease-out forwards;
      }

      /* Staggered animation for list items */
      .results-table tbody tr {
        animation: fadeIn var(--transition-normal) ease-out forwards;
      }

      .results-table tbody tr:nth-child(1) {
        animation-delay: 0ms;
      }
      .results-table tbody tr:nth-child(2) {
        animation-delay: 50ms;
      }
      .results-table tbody tr:nth-child(3) {
        animation-delay: 100ms;
      }
      .results-table tbody tr:nth-child(4) {
        animation-delay: 150ms;
      }
      .results-table tbody tr:nth-child(5) {
        animation-delay: 200ms;
      }
      .results-table tbody tr:nth-child(6) {
        animation-delay: 250ms;
      }
      .results-table tbody tr:nth-child(7) {
        animation-delay: 300ms;
      }
      .results-table tbody tr:nth-child(8) {
        animation-delay: 350ms;
      }

      .results-card {
        background-color: var(--color-surface);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        box-shadow: var(--shadow-sm);
        animation: slideIn var(--transition-normal) ease-out forwards;
      }

      .results-card:nth-child(1) {
        animation-delay: 0ms;
      }
      .results-card:nth-child(2) {
        animation-delay: 50ms;
      }
      .results-card:nth-child(3) {
        animation-delay: 100ms;
      }
      .results-card:nth-child(4) {
        animation-delay: 150ms;
      }
      .results-card:nth-child(5) {
        animation-delay: 200ms;
      }
      .results-card:nth-child(6) {
        animation-delay: 250ms;
      }
      .results-card:nth-child(7) {
        animation-delay: 300ms;
      }
      .results-card:nth-child(8) {
        animation-delay: 350ms;
      }

      /* Button loading state */
      .btn--loading {
        position: relative;
        pointer-events: none;
      }

      .btn--loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="container">
        <h1 class="header__title">
          <span class="header__text">Исламский Калькулятор Наследства</span>
        </h1>
        <p class="header__subtitle">
          Расчет долей наследства согласно Корану и Сунне
        </p>
      </div>
    </header>

    <!-- Modal: Предварительные обязательства (Шаг 0) -->
    <dialog id="obligations-modal" class="modal" aria-labelledby="modal-title">
      <div class="modal__content">
        <h2 id="modal-title" class="modal__title">
          Предварительные обязательства
        </h2>
        <p class="modal__description">
          Перед распределением наследства выполните:
        </p>

        <ul class="obligations-list">
          <li class="obligations-list__item">
            <span class="obligations-list__icon">🪦</span>
            <div class="obligations-list__content">
              <strong>Расходы на погребение</strong>
            </div>
          </li>
          <li class="obligations-list__item">
            <span class="obligations-list__icon">💰</span>
            <div class="obligations-list__content">
              <strong>Выплата долгов</strong>
            </div>
          </li>
          <li class="obligations-list__item">
            <span class="obligations-list__icon">📜</span>
            <div class="obligations-list__content">
              <strong>Исполнение завещания (васыйя)</strong>
              <p>Не более 1/3 имущества, не в пользу наследника</p>
            </div>
          </li>
          <li class="obligations-list__item">
            <span class="obligations-list__icon">⚖️</span>
            <div class="obligations-list__content">
              <strong>Распределение наследства</strong>
            </div>
          </li>
        </ul>

        <div class="modal__confirmation">
          <label class="checkbox">
            <input type="checkbox" id="obligations-checkbox" />
            <span class="checkbox__mark"></span>
            <span class="checkbox__label">Я понимаю порядок действий</span>
          </label>
        </div>

        <button id="continue-btn" class="btn btn--primary" disabled>
          Перейти к калькулятору
        </button>
      </div>
    </dialog>

    <!-- Main: Wizard калькулятора -->
    <main id="calculator-main" class="main hidden">
      <div class="container">
        <!-- Шаг 1: Ввод данных -->
        <section class="wizard-step active" data-step="input">
          <h2 class="section-title">Введите данные о наследстве</h2>

          <!-- Сумма наследства -->
          <div class="form-group">
            <label for="estate-amount" class="form-label"
              >Сумма наследства</label
            >
            <input
              type="text"
              id="estate-amount"
              class="form-input"
              placeholder="Введите сумму"
              inputmode="numeric"
            />
            <span class="form-hint"
              >Введите сумму после вычета долгов и завещания</span
            >
            <span class="form-error" id="estate-error"></span>
          </div>

          <!-- Супруги -->
          <div class="form-section">
            <h3 class="form-section__title">Супруг/супруга покойного</h3>
            <div class="radio-group">
              <label class="radio">
                <input type="radio" name="spouse" value="none" checked />
                <span class="radio__mark"></span>
                <span class="radio__label">Нет супруга</span>
              </label>
              <label class="radio">
                <input type="radio" name="spouse" value="husband" />
                <span class="radio__mark"></span>
                <span class="radio__label">Муж</span>
              </label>
              <label class="radio">
                <input type="radio" name="spouse" value="wife" />
                <span class="radio__mark"></span>
                <span class="radio__label">Жена</span>
              </label>
            </div>
            <span class="form-hint" id="spouse-hint"></span>
            <div id="wife-count-group" class="form-group hidden">
              <label for="wife-count" class="form-label">Количество жен</label>
              <input
                type="number"
                id="wife-count"
                class="form-input form-input--small"
                min="1"
                max="4"
                value="1"
              />
              <span class="form-hint"
                >Доля делится поровну между всеми женами</span
              >
            </div>
          </div>

          <!-- Потомки -->
          <details class="collapsible-section">
            <summary class="collapsible-section__header">
              <span class="collapsible-section__title"
                >Потомки (нисходящая линия)</span
              >
              <span class="collapsible-section__icon">▼</span>
            </summary>
            <div class="collapsible-section__content">
              <div class="form-grid">
                <div class="form-group">
                  <label for="sons" class="form-label">Сыновья</label>
                  <input
                    type="number"
                    id="sons"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="daughters" class="form-label">Дочери</label>
                  <input
                    type="number"
                    id="daughters"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="grandsons-from-son" class="form-label"
                    >Внуки от сына</label
                  >
                  <input
                    type="number"
                    id="grandsons-from-son"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                  <span
                    class="form-hint blocked-hint"
                    id="grandsons-blocked"
                  ></span>
                </div>
                <div class="form-group">
                  <label for="granddaughters-from-son" class="form-label"
                    >Внучки от сына</label
                  >
                  <input
                    type="number"
                    id="granddaughters-from-son"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                  <span
                    class="form-hint blocked-hint"
                    id="granddaughters-blocked"
                  ></span>
                </div>
              </div>
            </div>
          </details>

          <!-- Предки -->
          <details class="collapsible-section">
            <summary class="collapsible-section__header">
              <span class="collapsible-section__title"
                >Предки (восходящая линия)</span
              >
              <span class="collapsible-section__icon">▼</span>
            </summary>
            <div class="collapsible-section__content">
              <div class="checkbox-group">
                <label class="checkbox">
                  <input type="checkbox" id="father" />
                  <span class="checkbox__mark"></span>
                  <span class="checkbox__label">Отец</span>
                </label>
                <label class="checkbox">
                  <input type="checkbox" id="mother" />
                  <span class="checkbox__mark"></span>
                  <span class="checkbox__label">Мать</span>
                </label>
                <label class="checkbox">
                  <input type="checkbox" id="paternal-grandfather" />
                  <span class="checkbox__mark"></span>
                  <span class="checkbox__label">Дед (отец отца)</span>
                  <span
                    class="form-hint blocked-hint"
                    id="grandfather-blocked"
                  ></span>
                </label>
                <label class="checkbox">
                  <input type="checkbox" id="paternal-grandmother" />
                  <span class="checkbox__mark"></span>
                  <span class="checkbox__label">Бабушка (мать отца)</span>
                  <span
                    class="form-hint blocked-hint"
                    id="paternal-grandmother-blocked"
                  ></span>
                </label>
                <label class="checkbox">
                  <input type="checkbox" id="maternal-grandmother" />
                  <span class="checkbox__mark"></span>
                  <span class="checkbox__label">Бабушка (мать матери)</span>
                </label>
              </div>
            </div>
          </details>

          <!-- Братья и сестры -->
          <details class="collapsible-section">
            <summary class="collapsible-section__header">
              <span class="collapsible-section__title"
                >Братья и сестры (<span
                  class="tooltip"
                  data-tooltip="Братья и сестры покойного"
                  >аль-ихуа</span
                >)</span
              >
              <span class="collapsible-section__icon">▼</span>
            </summary>
            <div class="collapsible-section__content">
              <!-- Родные -->
              <h4 class="form-subsection-title">Родные (полнородные)</h4>
              <div class="form-grid">
                <div class="form-group">
                  <label for="full-brothers" class="form-label">Братья</label>
                  <input
                    type="number"
                    id="full-brothers"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                  <span
                    class="form-hint blocked-hint"
                    id="full-brothers-blocked"
                  ></span>
                </div>
                <div class="form-group">
                  <label for="full-sisters" class="form-label">Сестры</label>
                  <input
                    type="number"
                    id="full-sisters"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                  <span
                    class="form-hint blocked-hint"
                    id="full-sisters-blocked"
                  ></span>
                </div>
              </div>

              <!-- Единокровные -->
              <h4 class="form-subsection-title">Единокровные (по отцу)</h4>
              <div class="form-grid">
                <div class="form-group">
                  <label for="paternal-brothers" class="form-label"
                    >Братья</label
                  >
                  <input
                    type="number"
                    id="paternal-brothers"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                  <span
                    class="form-hint blocked-hint"
                    id="paternal-brothers-blocked"
                  ></span>
                </div>
                <div class="form-group">
                  <label for="paternal-sisters" class="form-label"
                    >Сестры</label
                  >
                  <input
                    type="number"
                    id="paternal-sisters"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                  <span
                    class="form-hint blocked-hint"
                    id="paternal-sisters-blocked"
                  ></span>
                </div>
              </div>

              <!-- Единоутробные -->
              <h4 class="form-subsection-title">Единоутробные (по матери)</h4>
              <div class="form-grid">
                <div class="form-group">
                  <label for="maternal-brothers" class="form-label"
                    >Братья</label
                  >
                  <input
                    type="number"
                    id="maternal-brothers"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                  <p
                    class="form-hint blocked-hint"
                    id="maternal-brothers-blocked"
                  ></p>
                </div>
                <div class="form-group">
                  <label for="maternal-sisters" class="form-label"
                    >Сестры</label
                  >
                  <input
                    type="number"
                    id="maternal-sisters"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                  <p
                    class="form-hint blocked-hint"
                    id="maternal-sisters-blocked"
                  ></p>
                </div>
              </div>

              <!-- Дальние наследники-асааба по мужской линии -->
              <h4 class="form-subsection-title">
                Дальние наследники по мужской линии (асааба)
              </h4>
              <div class="form-grid">
                <div class="form-group">
                  <label for="nephews-full-brothers" class="form-label"
                    >Сыны полнородных братьев (племянники)</label
                  >
                  <input
                    type="number"
                    id="nephews-full-brothers"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="nephews-paternal-brothers" class="form-label"
                    >Сыны единокровных братьев (племянники)</label
                  >
                  <input
                    type="number"
                    id="nephews-paternal-brothers"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="uncles-full" class="form-label"
                    >Дяди (родные братья отца)</label
                  >
                  <input
                    type="number"
                    id="uncles-full"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="uncles-paternal" class="form-label"
                    >Дяди (единокровные братья отца)</label
                  >
                  <input
                    type="number"
                    id="uncles-paternal"
                    class="form-input"
                    min="0"
                    value="0"
                  />
                </div>
              </div>
              <p class="form-hint blocked-hint" id="distant-asaba-blocked"></p>
            </div>
          </details>

          <div class="form-actions">
            <button id="calculate-btn" class="btn btn--primary btn--large">
              Рассчитать наследство
            </button>
          </div>
        </section>
      </div>
    </main>

    <!-- Section: Результаты -->
    <section id="results-section" class="results-section hidden">
      <div class="container">
        <h2 class="section-title">Результаты расчета</h2>

        <!-- Уведомления об особых случаях -->
        <div id="special-notices" class="notices"></div>

        <!-- Таблица результатов -->
        <div class="results-table-wrapper">
          <table class="results-table" id="results-table">
            <thead>
              <tr>
                <th>Наследник</th>
                <th>Отношение</th>
                <th>Доля</th>
                <th>%</th>
                <th>Сумма</th>
                <th>Обоснование</th>
              </tr>
            </thead>
            <tbody id="results-body">
              <!-- Результаты будут добавлены динамически -->
            </tbody>
            <tfoot>
              <tr class="results-total">
                <td colspan="3"><strong>Итого</strong></td>
                <td id="total-percentage">100%</td>
                <td id="total-amount">0</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Мобильная версия результатов (карточки) -->
        <div class="results-cards" id="results-cards">
          <!-- Карточки будут добавлены динамически -->
        </div>

        <div id="remainder-panel" class="notice notice--info hidden">
          <span class="notice__icon">💠</span>
          <div>
            <strong>Остаток имущества</strong>
            <div class="remainder-summary">
              <span id="remainder-percentage">0%</span>
              ·
              <span id="remainder-amount">0</span>
              → Казна/Садакъа
            </div>
          </div>
        </div>

        <div class="results-actions">
          <button id="print-btn" class="btn btn--secondary">
            🖨️ Распечатать / Сохранить в PDF
          </button>
          <button id="recalculate-btn" class="btn btn--outline">
            ↩️ Новый расчет
          </button>
        </div>
      </div>
    </section>

    <!-- Section: Глоссарий -->
    <section id="glossary-section" class="glossary-section">
      <div class="container">
        <h2 class="section-title">📚 Глоссарий терминов</h2>
        <div class="glossary-grid" id="glossary-grid">
          <!-- Термины будут добавлены динамически или статически -->
          <dl class="glossary-item">
            <dt class="glossary-term">
              <span class="glossary-term__ar">عصبة</span>
              <span class="glossary-term__ru">Асаба</span>
            </dt>
            <dd class="glossary-definition">
              Наследники по мужской линии, получающие остаток имущества после
              распределения фиксированных долей.
            </dd>
          </dl>
          <dl class="glossary-item">
            <dt class="glossary-term">
              <span class="glossary-term__ar">العول</span>
              <span class="glossary-term__ru">Аль-Авль</span>
            </dt>
            <dd class="glossary-definition">
              Пропорциональное уменьшение долей всех наследников, когда сумма
              фиксированных долей превышает 100%.
            </dd>
          </dl>
          <dl class="glossary-item">
            <dt class="glossary-term">
              <span class="glossary-term__ar">الرد</span>
              <span class="glossary-term__ru">Ар-Радд</span>
            </dt>
            <dd class="glossary-definition">
              Пропорциональное распределение остатка имущества между
              наследниками с фиксированной долей при отсутствии асаба.
            </dd>
          </dl>
          <dl class="glossary-item">
            <dt class="glossary-term">
              <span class="glossary-term__ar">الحجب</span>
              <span class="glossary-term__ru">Хиджб</span>
            </dt>
            <dd class="glossary-definition">
              Лишение наследника его доли из-за наличия более близкого
              родственника.
            </dd>
          </dl>
          <dl class="glossary-item">
            <dt class="glossary-term">
              <span class="glossary-term__ar">الكلالة</span>
              <span class="glossary-term__ru">Каляля</span>
            </dt>
            <dd class="glossary-definition">
              Покойный, не оставивший ни родителей, ни детей.
            </dd>
          </dl>
          <dl class="glossary-item">
            <dt class="glossary-term">
              <span class="glossary-term__ar">ذوو الأرحام</span>
              <span class="glossary-term__ru">Зави аль-архам</span>
            </dt>
            <dd class="glossary-definition">
              Родственники, не входящие в категории асхаб аль-фуруд и асаба
              (например, тетя по матери).
            </dd>
          </dl>
          <dl class="glossary-item">
            <dt class="glossary-term">
              <span class="glossary-term__ar">الفروض</span>
              <span class="glossary-term__ru">Фуруд</span>
            </dt>
            <dd class="glossary-definition">
              Фиксированные доли наследства, установленные Кораном: 1/2, 1/4,
              1/8, 2/3, 1/3, 1/6.
            </dd>
          </dl>
          <dl class="glossary-item">
            <dt class="glossary-term">
              <span class="glossary-term__ar">الوصية</span>
              <span class="glossary-term__ru">Васыйя</span>
            </dt>
            <dd class="glossary-definition">
              Завещание, которое не может превышать 1/3 имущества и не может
              быть в пользу наследника.
            </dd>
          </dl>
        </div>
      </div>
    </section>

    <!-- Section: FAQ -->
    <section id="faq-section" class="faq-section">
      <div class="container">
        <h2 class="section-title">❓ Часто задаваемые вопросы</h2>
        <div class="faq-accordion" id="faq-accordion">
          <details class="faq-item">
            <summary class="faq-question">
              Почему доля мужчины больше доли женщины?
            </summary>
            <div class="faq-answer">
              <p>
                В исламском праве мужчина несёт полную финансовую
                ответственность за содержание семьи (жены, детей, родителей), в
                то время как женщина не обязана тратить своё имущество на семью
                — даже если она богата. Всевышний Аллах сказал:
                <em
                  >«Мужчины являются попечителями женщин, потому что Аллах дал
                  одним из них преимущество перед другими, и потому что они
                  расходуют из своего имущества»</em
                >
                (сура «ан-Ниса», 4:34).
              </p>
              <p>
                Таким образом, бо́льшая доля мужчины компенсируется его
                обязанностями по содержанию. Женщина же сохраняет своё
                наследство полностью для себя.
              </p>
            </div>
          </details>

          <details class="faq-item">
            <summary class="faq-question">
              Какие аяты Корана устанавливают доли наследников?
            </summary>
            <div class="faq-answer">
              <p>
                Основные правила наследования установлены в суре «ан-Ниса»
                (4:11-12, 176):
              </p>
              <p>
                <strong>Аят 11:</strong>
                <em
                  >«Аллах заповедует вам относительно ваших детей: мужчине
                  достаётся доля, равная доле двух женщин. Если все дети
                  являются женщинами числом более двух, то им принадлежит две
                  трети того, что он оставил. Если же есть только одна дочь, то
                  ей принадлежит половина. Каждому из родителей принадлежит одна
                  шестая того, что он оставил, если у него есть ребёнок. Если же
                  у него нет ребёнка, и ему наследуют родители, то его матери
                  принадлежит одна треть. Если же у него есть братья, то его
                  матери принадлежит одна шестая. Таков расчёт после вычета по
                  завещанию и выплаты долга...»</em
                >
              </p>
              <p>
                <strong>Аят 12:</strong>
                <em
                  >«Вам принадлежит половина того, что оставили ваши жёны, если
                  у них нет ребёнка. Если же у них есть ребёнок, то вам
                  принадлежит четверть того, что они оставили. Им принадлежит
                  четверть того, что вы оставили, если у вас нет ребёнка. Если
                  же у вас есть ребёнок, то им принадлежит одна восьмая того,
                  что вы оставили...»</em
                >
              </p>
            </div>
          </details>

          <details class="faq-item">
            <summary class="faq-question">Может ли убийца наследовать?</summary>
            <div class="faq-answer">
              <p>
                Нет, убийца не может наследовать от убитого им человека. Пророк
                ﷺ сказал: <em>«Убийца не наследует ничего»</em>
                (Абу Дауд, 4564; ат-Тирмизи, 2109; Ибн Маджа, 2645).
              </p>
              <p>
                Это правило установлено для предотвращения преступлений ради
                наследства. Учёные единогласны (иджма) в том, что умышленное
                убийство лишает права наследования. В отношении неумышленного
                убийства существуют разногласия между мазхабами.
              </p>
            </div>
          </details>

          <details class="faq-item">
            <summary class="faq-question">
              Наследуют ли между собой мусульмане и немусульмане?
            </summary>
            <div class="faq-answer">
              <p>
                Согласно большинству учёных — нет. Пророк ﷺ сказал:
                <em
                  >«Мусульманин не наследует от неверующего, и неверующий не
                  наследует от мусульманина»</em
                >
                (аль-Бухари, 6764; Муслим, 1614).
              </p>
              <p>
                Это правило основано на различии религий, которое прерывает
                наследственную связь. Однако некоторые современные учёные
                допускают наследование мусульманина от немусульманина (но не
                наоборот), опираясь на мнение Муаза ибн Джабаля.
              </p>
            </div>
          </details>

          <details class="faq-item">
            <summary class="faq-question">
              Откуда берётся доля бабушки (1/6)?
            </summary>
            <div class="faq-answer">
              <p>
                Доля бабушки не упомянута в Коране напрямую, но установлена
                Сунной. Передаётся от аль-Мугиры ибн Шу'бы, что Пророк ﷺ выделил
                бабушке одну шестую часть наследства (Абу Дауд, 2894;
                ат-Тирмизи, 2100).
              </p>
              <p>
                Также передаётся от Кабисы ибн Зуайба:
                <em
                  >«К Абу Бакру пришла бабушка, спрашивая о своём наследстве. Он
                  сказал ей: "В Книге Аллаха нет для тебя ничего, и я не знаю,
                  чтобы Посланник Аллаха ﷺ что-то определил для тебя". Затем он
                  спросил людей, и аль-Мугира сказал: "Посланник Аллаха ﷺ дал ей
                  одну шестую". Абу Бакр спросил: "Есть ли ещё кто-то, кто знает
                  это?" Мухаммад ибн Маслама подтвердил это, и Абу Бакр выделил
                  ей (одну шестую)»</em
                >
                (Абу Дауд, 2894).
              </p>
            </div>
          </details>

          <details class="faq-item">
            <summary class="faq-question">
              Что делать, если сумма долей превышает 100%?
            </summary>
            <div class="faq-answer">
              <p>
                В этом случае применяется правило <strong>аль-Авль</strong> —
                пропорциональное уменьшение всех долей. Это решение было принято
                халифом Умаром ибн аль-Хаттабом (да будет доволен им Аллах),
                когда впервые возникла такая ситуация.
              </p>
              <p>
                Пример: муж (1/2), две сестры (2/3), мать (1/6) = 1/2 + 2/3 +
                1/6 = 8/6. Знаменатель увеличивается с 6 до 8, и доли
                становятся: муж — 3/8, сёстры — 4/8, мать — 1/8. Так сохраняется
                справедливая пропорция.
              </p>
            </div>
          </details>

          <details class="faq-item">
            <summary class="faq-question">
              Как распределяется наследство при отсутствии наследников?
            </summary>
            <div class="faq-answer">
              <p>
                Если у покойного нет наследников из числа родственников,
                имущество переходит в <strong>байт аль-маль</strong> (казну
                мусульман) для использования на общественные нужды.
              </p>
              <p>
                Пророк ﷺ сказал:
                <em
                  >«Я ближе к верующим, чем они сами к себе. Кто умрёт, оставив
                  долг и не оставив имущества для его погашения, то его
                  погашение — на мне. А кто оставит имущество, то оно — его
                  наследникам»</em
                >
                (аль-Бухари, 2298; Муслим, 1619).
              </p>
            </div>
          </details>

          <details class="faq-item">
            <summary class="faq-question">
              Какой порядок действий при распределении наследства?
            </summary>
            <div class="faq-answer">
              <p>
                Согласно Корану и Сунне, наследство распределяется в следующем
                порядке:
              </p>
              <ol
                style="
                  margin: var(--spacing-sm) 0;
                  padding-left: var(--spacing-lg);
                "
              >
                <li>
                  <strong>Расходы на похороны</strong> — достойное погребение
                  покойного
                </li>
                <li>
                  <strong>Погашение долгов</strong> — все долги покойного перед
                  людьми и Аллахом (закят, каффара)
                </li>
                <li>
                  <strong>Исполнение завещания</strong> — не более 1/3
                  оставшегося имущества, не в пользу наследника
                </li>
                <li>
                  <strong>Распределение наследства</strong> — согласно
                  установленным долям
                </li>
              </ol>
              <p>
                Аллах сказал:
                <em
                  >«...после вычета по завещанию, которое он завещал, или
                  выплаты долга»</em
                >
                (сура «ан-Ниса», 4:11).
              </p>
            </div>
          </details>

          <details class="faq-item">
            <summary class="faq-question">
              Почему важно изучать ильм аль-фараид?
            </summary>
            <div class="faq-answer">
              <p>
                Пророк ﷺ придавал этой науке особое значение. Он сказал:
                <em
                  >«Поистине, знание о наследстве — половина всего знания, и оно
                  первым будет утрачено из знания моей Уммы. Придут времена,
                  когда двое будут спорить о наследстве, но не найдут того, кто
                  рассудил бы их».</em
                >
                (Ибн Маджа, 2719, Шейх аль-Албани включил этот хадис в «Сахих
                Сунан Ибн Маджа» под № 2197 и оценил его как сахих
                (достоверный).).
              </p>
            </div>
          </details>

          <details class="faq-item">
            <summary class="faq-question">
              Можно ли отказаться от своей доли наследства?
            </summary>
            <div class="faq-answer">
              <p>
                Да, наследник имеет право добровольно отказаться от своей доли в
                пользу других наследников после того, как право на наследство
                уже возникло (после смерти наследодателя).
              </p>
              <p>
                Это основано на общем принципе дозволенности дарения своего
                имущества. Аллах сказал:
                <em
                  >«...а если они по доброй воле откажутся от чего-либо в вашу
                  пользу, то вкушайте это во благо и на здоровье»</em
                >
                (сура «ан-Ниса», 4:4). Однако нельзя заставлять наследника
                отказаться от своей доли.
              </p>
            </div>
          </details>

          <details class="faq-item">
            <summary class="faq-question">
              Почему братья делятся на полнородных, единокровных и
              единоутробных?
            </summary>
            <div class="faq-answer">
              <p>
                Разделение на полнородных, единокровных и единоутробных
                братьев/сестёр — это часть классической терминологии исламского
                наследственного права, основанной на биологическом
                происхождении. Каждая категория имеет разные права наследования.
              </p>

              <p>
                <strong
                  >1. Полнородные (аль-ихва аш-шикка / الأخ الشقيق)</strong
                >
              </p>
              <p>
                Общие и отец, и мать с покойным. Например: у вас и у вашего
                брата один и тот же отец и одна и та же мать.
              </p>
              <p><em>Права:</em></p>
              <ul
                style="
                  margin: var(--spacing-xs) 0;
                  padding-left: var(--spacing-lg);
                "
              >
                <li>Имеют наибольший приоритет среди братьев/сестёр</li>
                <li>
                  Могут быть асаба (наследуют остаток после фиксированных долей)
                </li>
                <li>Могут блокировать единокровных братьев/сестёр</li>
              </ul>

              <p>
                <strong
                  >2. Единокровные — по отцу (аль-ихва лиль-аб / الأخ
                  لأب)</strong
                >
              </p>
              <p>
                Общий отец, но разные матери. Например: ваш отец женился дважды.
                Вы — от первой жены, ваш брат — от второй.
              </p>
              <p><em>Права:</em></p>
              <ul
                style="
                  margin: var(--spacing-xs) 0;
                  padding-left: var(--spacing-lg);
                "
              >
                <li>
                  Наследуют только если нет полнородных братьев/сестёр и нет
                  потомков/отца
                </li>
                <li>
                  Также могут быть асаба, но ниже в иерархии, чем полнородные
                </li>
                <li>Блокируются полнородными братьями</li>
              </ul>

              <p>
                <strong
                  >3. Единоутробные — по матери (аль-ихва лиль-умм / الأخ
                  لأم)</strong
                >
              </p>
              <p>
                Общая мать, но разные отцы. Например: ваша мать выходила замуж
                дважды. Вы — от первого мужа, ваш брат — от второго.
              </p>
              <p><em>Права:</em></p>
              <ul
                style="
                  margin: var(--spacing-xs) 0;
                  padding-left: var(--spacing-lg);
                "
              >
                <li>Никогда не бывают асаба</li>
                <li>
                  Получают фиксированную долю: 1/6 — если один; 1/3 — если двое
                  и более (вместе, независимо от пола)
                </li>
                <li>
                  Блокируются при наличии отца, деда, сына, внука от сына,
                  дочери или внучки от сына
                </li>
              </ul>

              <p>
                <strong>📌 Далиль из Корана:</strong>
                <em
                  >«Если у него (покойного) братья по матери, то каждому из них
                  — шестая часть... Если же их больше одного, то они совместно
                  получают треть»</em
                >
                (сура «ан-Ниса», 4:12).
              </p>

              <p><strong>❓ Почему это важно?</strong></p>
              <ul
                style="
                  margin: var(--spacing-xs) 0;
                  padding-left: var(--spacing-lg);
                "
              >
                <li>
                  <strong>Права кардинально отличаются:</strong> полнородные и
                  единокровные могут получить всё оставшееся имущество (если
                  других наследников нет), а единоутробные — только
                  фиксированную долю
                </li>
                <li>
                  <strong>Принцип хиджба (блокировки):</strong> наличие сына или
                  отца блокирует всех братьев и сестёр; наличие полнородного
                  брата блокирует единокровных
                </li>
                <li>
                  <strong>Справедливость:</strong> исламская система стремится
                  передать имущество тем, кто ближе всего связан кровью по обеим
                  линиям
                </li>
              </ul>
            </div>
          </details>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="disclaimer">
          <h3 class="disclaimer__title">⚠️ Важное уведомление</h3>
          <p class="disclaimer__text">
            Данный калькулятор носит исключительно ознакомительный характер и
            предназначен для понимания принципамов исламского наследственного
            права ('ильм аль-фараид).
          </p>
          <p class="disclaimer__text">
            Для вынесения фетвы и решения конкретных вопросов наследства
            обязательно обратитесь к квалифицированному ученому (алиму) или
            муфтию.
          </p>
          <p class="disclaimer__text">
            <strong>Внимание:</strong> Результаты расчета не являются
            официальным заключением и не могут использоваться в качестве
            юридического документа.
          </p>
        </div>
        <div class="footer__copyright">
          <p>© 2026 Исламский Калькулятор Наследства</p>
        </div>
      </div>
    </footer>

    <script>
      // ========================================
      // Fraction Class - Работа с дробями
      // ========================================

      /**
       * Класс для работы с дробями
       * Обеспечивает точные вычисления без потери точности при работе с долями наследства
       */
      class Fraction {
        /**
         * Создает новую дробь
         * @param {number} numerator - числитель
         * @param {number} denominator - знаменатель (не может быть 0)
         */
        constructor(numerator, denominator = 1) {
          if (denominator === 0) {
            throw new Error("Знаменатель не может быть равен нулю");
          }

          // Нормализуем знак: знак всегда в числителе
          if (denominator < 0) {
            numerator = -numerator;
            denominator = -denominator;
          }

          this.num = numerator;
          this.den = denominator;
        }

        /**
         * Вычисляет наибольший общий делитель (НОД) двух чисел
         * Используется алгоритм Евклида
         * @param {number} a - первое число
         * @param {number} b - второе число
         * @returns {number} - НОД
         */
        static gcd(a, b) {
          a = Math.abs(a);
          b = Math.abs(b);
          while (b !== 0) {
            const temp = b;
            b = a % b;
            a = temp;
          }
          return a;
        }

        /**
         * Вычисляет наименьшее общее кратное (НОК) двух чисел
         * @param {number} a - первое число
         * @param {number} b - второе число
         * @returns {number} - НОК
         */
        static lcm(a, b) {
          return Math.abs(a * b) / Fraction.gcd(a, b);
        }

        /**
         * Упрощает дробь, деля числитель и знаменатель на их НОД
         * @returns {Fraction} - новая упрощенная дробь
         */
        simplify() {
          if (this.num === 0) {
            return new Fraction(0, 1);
          }
          const gcd = Fraction.gcd(this.num, this.den);
          return new Fraction(this.num / gcd, this.den / gcd);
        }

        /**
         * Складывает две дроби
         * @param {Fraction} other - другая дробь
         * @returns {Fraction} - результат сложения (упрощенный)
         */
        add(other) {
          if (!(other instanceof Fraction)) {
            other = new Fraction(other);
          }
          // a/b + c/d = (a*d + c*b) / (b*d)
          const newNum = this.num * other.den + other.num * this.den;
          const newDen = this.den * other.den;
          return new Fraction(newNum, newDen).simplify();
        }

        /**
         * Вычитает дробь из текущей
         * @param {Fraction} other - вычитаемая дробь
         * @returns {Fraction} - результат вычитания (упрощенный)
         */
        subtract(other) {
          if (!(other instanceof Fraction)) {
            other = new Fraction(other);
          }
          // a/b - c/d = (a*d - c*b) / (b*d)
          const newNum = this.num * other.den - other.num * this.den;
          const newDen = this.den * other.den;
          return new Fraction(newNum, newDen).simplify();
        }

        /**
         * Умножает две дроби
         * @param {Fraction} other - другая дробь
         * @returns {Fraction} - результат умножения (упрощенный)
         */
        multiply(other) {
          if (!(other instanceof Fraction)) {
            other = new Fraction(other);
          }
          // a/b * c/d = (a*c) / (b*d)
          return new Fraction(
            this.num * other.num,
            this.den * other.den
          ).simplify();
        }

        /**
         * Делит текущую дробь на другую
         * @param {Fraction} other - делитель
         * @returns {Fraction} - результат деления (упрощенный)
         */
        divide(other) {
          if (!(other instanceof Fraction)) {
            other = new Fraction(other);
          }
          if (other.num === 0) {
            throw new Error("Деление на ноль");
          }
          // a/b ÷ c/d = (a*d) / (b*c)
          return new Fraction(
            this.num * other.den,
            this.den * other.num
          ).simplify();
        }

        /**
         * Преобразует дробь в десятичное число
         * @returns {number} - десятичное представление
         */
        toDecimal() {
          return this.num / this.den;
        }

        /**
         * Преобразует дробь в строку вида "числитель/знаменатель"
         * @returns {string} - строковое представление
         */
        toString() {
          if (this.den === 1) {
            return String(this.num);
          }
          return `${this.num}/${this.den}`;
        }

        /**
         * Проверяет равенство двух дробей
         * @param {Fraction} other - другая дробь
         * @returns {boolean} - true если дроби равны
         */
        equals(other) {
          if (!(other instanceof Fraction)) {
            other = new Fraction(other);
          }
          // Упрощаем обе дроби и сравниваем
          const simplified1 = this.simplify();
          const simplified2 = other.simplify();
          return (
            simplified1.num === simplified2.num &&
            simplified1.den === simplified2.den
          );
        }

        /**
         * Проверяет, больше ли текущая дробь другой
         * @param {Fraction} other - другая дробь
         * @returns {boolean}
         */
        greaterThan(other) {
          if (!(other instanceof Fraction)) {
            other = new Fraction(other);
          }
          return this.num * other.den > other.num * this.den;
        }

        /**
         * Проверяет, меньше ли текущая дробь другой
         * @param {Fraction} other - другая дробь
         * @returns {boolean}
         */
        lessThan(other) {
          if (!(other instanceof Fraction)) {
            other = new Fraction(other);
          }
          return this.num * other.den < other.num * this.den;
        }

        /**
         * Проверяет, является ли дробь нулем
         * @returns {boolean}
         */
        isZero() {
          return this.num === 0;
        }

        /**
         * Создает копию дроби
         * @returns {Fraction}
         */
        clone() {
          return new Fraction(this.num, this.den);
        }

        /**
         * Создает дробь из десятичного числа (приближенно)
         * @param {number} decimal - десятичное число
         * @param {number} precision - точность (максимальный знаменатель)
         * @returns {Fraction}
         */
        static fromDecimal(decimal, precision = 1000000) {
          if (decimal === 0) return new Fraction(0, 1);

          const sign = decimal < 0 ? -1 : 1;
          decimal = Math.abs(decimal);

          // Используем алгоритм цепных дробей для лучшего приближения
          let bestNum = 1;
          let bestDen = 1;
          let bestError = Math.abs(decimal - bestNum / bestDen);

          for (let den = 1; den <= precision; den++) {
            const num = Math.round(decimal * den);
            const error = Math.abs(decimal - num / den);
            if (error < bestError) {
              bestError = error;
              bestNum = num;
              bestDen = den;
              if (error === 0) break;
            }
          }

          return new Fraction(sign * bestNum, bestDen).simplify();
        }
      }

      // ========================================
      // Blocking Rules System (Хиджб)
      // ========================================

      /**
       * Правила блокировки для каждого типа наследника
       * Каждое правило - функция, принимающая состояние наследников и возвращающая boolean
       * Requirements: 9.1, 9.2, 9.3, 9.4, 9.5
       */
      const BlockingRules = {
        /**
         * Дед (отец отца) блокируется отцом
         * Requirements: 9.1
         */
        paternalGrandfather: (heirs) => heirs.father === true,

        /**
         * Бабушка по отцу блокируется матерью
         * Requirements: 9.5
         */
        paternalGrandmother: (heirs) => heirs.mother === true,

        /**
         * Внуки от сына блокируются сыновьями
         * Requirements: 9.2, 4.2
         */
        grandsonsFromSon: (heirs) => heirs.sons > 0,

        /**
         * Внучки от сына блокируются сыновьями
         * Requirements: 9.2, 4.2
         */
        granddaughtersFromSon: (heirs) => heirs.sons > 0,

        /**
         * Родные братья блокируются отцом, дедом, сыном или внуком от сына
         * Requirements: 9.3, 6.3
         */
        fullBrothers: (heirs) =>
          heirs.father === true ||
          heirs.paternalGrandfather === true ||
          heirs.sons > 0 ||
          heirs.grandsonsFromSon > 0,

        /**
         * Родные сестры блокируются отцом, дедом, сыном или внуком от сына
         * Requirements: 9.3, 6.3
         */
        fullSisters: (heirs) =>
          heirs.father === true ||
          heirs.paternalGrandfather === true ||
          heirs.sons > 0 ||
          heirs.grandsonsFromSon > 0,

        /**
         * Единокровные братья (по отцу) блокируются:
         * - отцом, дедом, сыном или внуком от сына (как все братья)
         * - родными братьями
         * Requirements: 9.3, 9.4, 6.3, 6.4
         */
        paternalBrothers: (heirs) =>
          heirs.father === true ||
          heirs.paternalGrandfather === true ||
          heirs.sons > 0 ||
          heirs.grandsonsFromSon > 0 ||
          heirs.fullBrothers > 0,

        /**
         * Единокровные сестры (по отцу) блокируются:
         * - отцом, дедом, сыном или внуком от сына (как все братья/сестры)
         * - родными братьями
         * Requirements: 9.3, 9.4, 6.3, 6.4
         */
        paternalSisters: (heirs) =>
          heirs.father === true ||
          heirs.paternalGrandfather === true ||
          heirs.sons > 0 ||
          heirs.grandsonsFromSon > 0 ||
          heirs.fullBrothers > 0,

        /**
         * Единоутробные братья блокируются отцом, дедом или любыми потомками
         * Requirements: 9.3, 9.6
         */
        maternalBrothers: (heirs) =>
          heirs.father === true ||
          heirs.paternalGrandfather === true ||
          heirs.sons > 0 ||
          heirs.daughters > 0 ||
          heirs.grandsonsFromSon > 0 ||
          heirs.granddaughtersFromSon > 0,

        /**
         * Единоутробные сестры блокируются отцом, дедом или любыми потомками
         * Requirements: 9.3, 9.6
         */
        maternalSisters: (heirs) =>
          heirs.father === true ||
          heirs.paternalGrandfather === true ||
          heirs.sons > 0 ||
          heirs.daughters > 0 ||
          heirs.grandsonsFromSon > 0 ||
          heirs.granddaughtersFromSon > 0,
      };

      /**
       * Причины блокировки для каждого типа наследника
       * Возвращает человекочитаемое объяснение причины блокировки
       */
      const BlockingReasons = {
        paternalGrandfather: {
          father: "Блокируется отцом",
        },
        paternalGrandmother: {
          mother: "Блокируется матерью",
        },
        grandsonsFromSon: {
          sons: "Блокируется сыном",
        },
        granddaughtersFromSon: {
          sons: "Блокируется сыном",
        },
        fullBrothers: {
          father: "Блокируется отцом",
          paternalGrandfather: "Блокируется дедом (отцом отца)",
          sons: "Блокируется сыном",
          grandsonsFromSon: "Блокируется внуком от сына",
        },
        fullSisters: {
          father: "Блокируется отцом",
          paternalGrandfather: "Блокируется дедом (отцом отца)",
          sons: "Блокируется сыном",
          grandsonsFromSon: "Блокируется внуком от сына",
        },
        paternalBrothers: {
          father: "Блокируется отцом",
          paternalGrandfather: "Блокируется дедом (отцом отца)",
          sons: "Блокируется сыном",
          grandsonsFromSon: "Блокируется внуком от сына",
          fullBrothers: "Блокируется родным братом",
        },
        paternalSisters: {
          father: "Блокируется отцом",
          paternalGrandfather: "Блокируется дедом (отцом отца)",
          sons: "Блокируется сыном",
          grandsonsFromSon: "Блокируется внуком от сына",
          fullBrothers: "Блокируется родным братом",
        },
        maternalBrothers: {
          father: "Блокируется отцом",
          paternalGrandfather: "Блокируется дедом (отцом отца)",
          sons: "Блокируется потомками",
          daughters: "Блокируется потомками",
          grandsonsFromSon: "Блокируется потомками",
          granddaughtersFromSon: "Блокируется потомками",
        },
        maternalSisters: {
          father: "Блокируется отцом",
          paternalGrandfather: "Блокируется дедом (отцом отца)",
          sons: "Блокируется потомками",
          daughters: "Блокируется потомками",
          grandsonsFromSon: "Блокируется потомками",
          granddaughtersFromSon: "Блокируется потомками",
        },
      };

      /**
       * Проверяет, заблокирован ли наследник данного типа
       * @param {string} heirType - тип наследника (ключ из BlockingRules)
       * @param {object} heirs - объект состояния наследников
       * @returns {object} - { blocked: boolean, reason: string | null }
       */
      function checkBlocking(heirType, heirs) {
        const rule = BlockingRules[heirType];

        // Если для данного типа нет правила блокировки, он не блокируется
        if (!rule) {
          return { blocked: false, reason: null };
        }

        const blocked = rule(heirs);

        if (!blocked) {
          return { blocked: false, reason: null };
        }

        const reason = getBlockingReason(heirType, heirs);
        return { blocked: true, reason };
      }

      /**
       * Проверяет блокировку для простых случаев (дед, бабушка, внуки)
       * @param {string} heirType - тип наследника
       * @param {object} heirs - объект состояния наследников
       * @param {object} reasons - объект с причинами блокировки
       * @returns {string | null} - причина блокировки или null
       */
      function checkSimpleBlocking(heirType, heirs, reasons) {
        const simpleBlockingMap = {
          paternalGrandfather: () =>
            heirs.father === true ? reasons.father : null,
          paternalGrandmother: () =>
            heirs.mother === true ? reasons.mother : null,
          grandsonsFromSon: () => (heirs.sons > 0 ? reasons.sons : null),
          granddaughtersFromSon: () => (heirs.sons > 0 ? reasons.sons : null),
        };

        const checkFunction = simpleBlockingMap[heirType];
        return checkFunction ? checkFunction() : null;
      }

      /**
       * Проверяет блокировку для родных братьев/сестер
       * @param {object} heirs - объект состояния наследников
       * @param {object} reasons - объект с причинами блокировки
       * @returns {string | null} - причина блокировки или null
       */
      function checkFullSiblingsBlocking(heirs, reasons) {
        if (heirs.father === true) return reasons.father;
        if (heirs.sons > 0) return reasons.sons;
        if (heirs.grandsonsFromSon > 0) return reasons.grandsonsFromSon;
        return null;
      }

      /**
       * Проверяет блокировку для единокровных братьев/сестер
       * @param {object} heirs - объект состояния наследников
       * @param {object} reasons - объект с причинами блокировки
       * @returns {string | null} - причина блокировки или null
       */
      function checkPaternalSiblingsBlocking(heirs, reasons) {
        if (heirs.father === true) return reasons.father;
        if (heirs.sons > 0) return reasons.sons;
        if (heirs.grandsonsFromSon > 0) return reasons.grandsonsFromSon;
        if (heirs.fullBrothers > 0) return reasons.fullBrothers;
        return null;
      }

      /**
       * Проверяет блокировку для единоутробных братьев/сестер
       * @param {object} heirs - состояние наследников
       * @param {object} reasons - причины блокировки
       * @returns {string | null}
       */
      function checkMaternalSiblingsBlocking(heirs, reasons) {
        if (heirs.father === true) return reasons.father;
        if (heirs.sons > 0) return reasons.sons;
        if (heirs.daughters > 0) return reasons.daughters;
        if (heirs.grandsonsFromSon > 0) return reasons.grandsonsFromSon;
        if (heirs.granddaughtersFromSon > 0)
          return reasons.granddaughtersFromSon;
        return null;
      }

      /**
       * Получает причину блокировки наследника
       * @param {string} heirType - тип наследника
       * @param {object} heirs - объект состояния наследников
       * @returns {string | null} - причина блокировки или null
       */
      function getBlockingReason(heirType, heirs) {
        const reasons = BlockingReasons[heirType];
        if (!reasons) return null;

        // Проверяем простые случаи блокировки
        const simpleReason = checkSimpleBlocking(heirType, heirs, reasons);
        if (simpleReason) return simpleReason;

        // Проверяем родных братьев/сестер
        if (heirType === "fullBrothers" || heirType === "fullSisters") {
          return checkFullSiblingsBlocking(heirs, reasons);
        }

        // Проверяем единокровных братьев/сестер
        if (heirType === "paternalBrothers" || heirType === "paternalSisters") {
          return checkPaternalSiblingsBlocking(heirs, reasons);
        }

        // Проверяем единоутробных братьев/сестер
        if (heirType === "maternalBrothers" || heirType === "maternalSisters") {
          return checkMaternalSiblingsBlocking(heirs, reasons);
        }

        return null;
      }

      /**
       * Получает все блокировки для текущего состояния наследников
       * @param {object} heirs - объект состояния наследников
       * @returns {object} - объект с блокировками для каждого типа наследника
       */
      function getAllBlockings(heirs) {
        const blockings = {};

        for (const heirType of Object.keys(BlockingRules)) {
          blockings[heirType] = checkBlocking(heirType, heirs);
        }

        return blockings;
      }

      // ========================================
      // Inheritance Calculation Helpers
      // ========================================

      /**
       * Проверяет наличие детей или внуков от сына
       * @param {object} heirs - состояние наследников
       * @returns {boolean}
       */
      function hasChildren(heirs) {
        return (
          heirs.sons > 0 ||
          heirs.daughters > 0 ||
          heirs.grandsonsFromSon > 0 ||
          heirs.granddaughtersFromSon > 0
        );
      }

      /**
       * Проверяет наличие сыновей или внуков от сына (мужских потомков)
       * @param {object} heirs - состояние наследников
       * @returns {boolean}
       */
      function hasMaleDescendants(heirs) {
        return heirs.sons > 0 || heirs.grandsonsFromSon > 0;
      }

      /**
       * Проверяет наличие множества братьев/сестер (2 и более)
       * @param {object} heirs - состояние наследников
       * @returns {boolean}
       */
      function hasMultipleSiblings(heirs) {
        const totalSiblings =
          (heirs.fullBrothers || 0) +
          (heirs.fullSisters || 0) +
          (heirs.paternalBrothers || 0) +
          (heirs.paternalSisters || 0) +
          (heirs.maternalBrothers || 0) +
          (heirs.maternalSisters || 0);
        return totalSiblings >= 2;
      }

      /**
       * Типы наследников с правилами расчета долей
       */
      const HeirTypes = {
        HUSBAND: {
          id: "husband",
          nameRu: "Муж",
          nameAr: "الزوج",
          category: "spouse",
          gender: "male",
          isAsaba: false,
          getShare: (heirs) =>
            hasChildren(heirs) ? new Fraction(1, 4) : new Fraction(1, 2),
          dalil: 'Коран, сура "ан-Ниса", 4:12',
        },
        WIFE: {
          id: "wife",
          nameRu: "Жена",
          nameAr: "الزوجة",
          category: "spouse",
          gender: "female",
          isAsaba: false,
          getShare: (heirs) =>
            hasChildren(heirs) ? new Fraction(1, 8) : new Fraction(1, 4),
          dalil: 'Коран, сура "ан-Ниса", 4:12',
        },
        SON: {
          id: "son",
          nameRu: "Сын",
          nameAr: "الابن",
          category: "descendant",
          gender: "male",
          isAsaba: true,
          getShare: () => null,
          dalil: 'Коран, сура "ан-Ниса", 4:11',
        },
        DAUGHTER: {
          id: "daughter",
          nameRu: "Дочь",
          nameAr: "البنت",
          category: "descendant",
          gender: "female",
          isAsaba: false,
          getShare: (heirs) => {
            if (heirs.sons > 0) return null;
            if (heirs.daughters === 1) return new Fraction(1, 2);
            return new Fraction(2, 3);
          },
          dalil: 'Коран, сура "ан-Ниса", 4:11',
        },
        GRANDSON_FROM_SON: {
          id: "grandsonsFromSon",
          nameRu: "Внук от сына",
          nameAr: "ابن الابن",
          category: "descendant",
          gender: "male",
          isAsaba: true,
          getShare: () => null,
          dalil: 'Коран, сура "ан-Ниса", 4:11 (по аналогии с сыном)',
        },
        GRANDDAUGHTER_FROM_SON: {
          id: "granddaughtersFromSon",
          nameRu: "Внучка от сына",
          nameAr: "بنت الابن",
          category: "descendant",
          gender: "female",
          isAsaba: false,
          getShare: (heirs) => {
            if (heirs.grandsonsFromSon > 0) return null;
            if (heirs.daughters === 1) return new Fraction(1, 6);
            if (heirs.daughters >= 2) return new Fraction(0, 1);
            if (heirs.granddaughtersFromSon === 1) return new Fraction(1, 2);
            return new Fraction(2, 3);
          },
          dalil:
            'Хадис от Ибн Масуда (Бухари): "Внучке от сына — 1/6 как дополнение до 2/3"',
        },
        FATHER: {
          id: "father",
          nameRu: "Отец",
          nameAr: "الأب",
          category: "ascendant",
          gender: "male",
          isAsaba: true,
          getShare: (heirs) => {
            if (hasMaleDescendants(heirs)) return new Fraction(1, 6);
            if (heirs.daughters > 0 || heirs.granddaughtersFromSon > 0)
              return new Fraction(1, 6);
            return null;
          },
          dalil: 'Коран, сура "ан-Ниса", 4:11',
        },
        MOTHER: {
          id: "mother",
          nameRu: "Мать",
          nameAr: "الأم",
          category: "ascendant",
          gender: "female",
          isAsaba: false,
          getShare: (heirs) => {
            if (hasChildren(heirs) || hasMultipleSiblings(heirs))
              return new Fraction(1, 6);
            return new Fraction(1, 3);
          },
          dalil: 'Коран, сура "ан-Ниса", 4:11',
        },
        PATERNAL_GRANDFATHER: {
          id: "paternalGrandfather",
          nameRu: "Дед (отец отца)",
          nameAr: "الجد",
          category: "ascendant",
          gender: "male",
          isAsaba: true,
          getShare: (heirs) => {
            if (hasMaleDescendants(heirs)) return new Fraction(1, 6);
            if (heirs.daughters > 0 || heirs.granddaughtersFromSon > 0)
              return new Fraction(1, 6);
            return null;
          },
          dalil: "Иджма ученых: дед наследует как отец при его отсутствии",
        },
        PATERNAL_GRANDMOTHER: {
          id: "paternalGrandmother",
          nameRu: "Бабушка (мать отца)",
          nameAr: "الجدة من جهة الأب",
          category: "ascendant",
          gender: "female",
          isAsaba: false,
          getShare: () => new Fraction(1, 6),
          dalil: "Хадис: Пророк ﷺ выделил бабушке 1/6 (Абу Дауд, Тирмизи)",
        },
        MATERNAL_GRANDMOTHER: {
          id: "maternalGrandmother",
          nameRu: "Бабушка (мать матери)",
          nameAr: "الجدة من جهة الأم",
          category: "ascendant",
          gender: "female",
          isAsaba: false,
          getShare: () => new Fraction(1, 6),
          dalil: "Хадис: Пророк ﷺ выделил бабушке 1/6 (Абу Дауд, Тирмизи)",
        },
        FULL_BROTHER: {
          id: "fullBrothers",
          nameRu: "Родной брат",
          nameAr: "الأخ الشقيق",
          category: "sibling",
          gender: "male",
          isAsaba: true,
          getShare: () => null,
          dalil: 'Коран, сура "ан-Ниса", 4:176',
        },
        FULL_SISTER: {
          id: "fullSisters",
          nameRu: "Родная сестра",
          nameAr: "الأخت الشقيقة",
          category: "sibling",
          gender: "female",
          isAsaba: false,
          getShare: (heirs) => {
            if (heirs.fullBrothers > 0) return null;
            if (heirs.fullSisters === 1) return new Fraction(1, 2);
            return new Fraction(2, 3);
          },
          dalil: 'Коран, сура "ан-Ниса", 4:176',
        },
        PATERNAL_BROTHER: {
          id: "paternalBrothers",
          nameRu: "Единокровный брат",
          nameAr: "الأخ لأب",
          category: "sibling",
          gender: "male",
          isAsaba: true,
          getShare: () => null,
          dalil: 'Коран, сура "ан-Ниса", 4:176 (по аналогии)',
        },
        PATERNAL_SISTER: {
          id: "paternalSisters",
          nameRu: "Единокровная сестра",
          nameAr: "الأخت لأب",
          category: "sibling",
          gender: "female",
          isAsaba: false,
          getShare: (heirs) => {
            if (heirs.paternalBrothers > 0) return null;
            if (heirs.fullSisters === 1) return new Fraction(1, 6);
            if (heirs.fullSisters >= 2) return new Fraction(0, 1);
            if (heirs.paternalSisters === 1) return new Fraction(1, 2);
            return new Fraction(2, 3);
          },
          dalil: 'Коран, сура "ан-Ниса", 4:176 (по аналогии)',
        },
        MATERNAL_BROTHER: {
          id: "maternalBrothers",
          nameRu: "Единоутробный брат",
          nameAr: "الأخ لأم",
          category: "sibling",
          gender: "male",
          isAsaba: false,
          getShare: (heirs) => {
            if (heirs.father || hasChildren(heirs)) return new Fraction(0, 1);
            const totalMaternal =
              (heirs.maternalBrothers || 0) + (heirs.maternalSisters || 0);
            if (totalMaternal === 1) return new Fraction(1, 6);
            return new Fraction(1, 3);
          },
          dalil: 'Коран, сура "ан-Ниса", 4:12',
        },
        MATERNAL_SISTER: {
          id: "maternalSisters",
          nameRu: "Единоутробная сестра",
          nameAr: "الأخت لأم",
          category: "sibling",
          gender: "female",
          isAsaba: false,
          getShare: (heirs) => {
            if (heirs.father || hasChildren(heirs)) return new Fraction(0, 1);
            const totalMaternal =
              (heirs.maternalBrothers || 0) + (heirs.maternalSisters || 0);
            if (totalMaternal === 1) return new Fraction(1, 6);
            return new Fraction(1, 3);
          },
          dalil: 'Коран, сура "ан-Ниса", 4:12',
        },
      };

      /**
       * Порядок приоритета асаба
       */
      const AsabaPriority = [
        { key: "sons", type: HeirTypes.SON, countField: "sons" },
        {
          key: "grandsonsFromSon",
          type: HeirTypes.GRANDSON_FROM_SON,
          countField: "grandsonsFromSon",
        },
        { key: "father", type: HeirTypes.FATHER, countField: "father" },
        {
          key: "paternalGrandfather",
          type: HeirTypes.PATERNAL_GRANDFATHER,
          countField: "paternalGrandfather",
        },
        {
          key: "fullBrothers",
          type: HeirTypes.FULL_BROTHER,
          countField: "fullBrothers",
        },
        {
          key: "paternalBrothers",
          type: HeirTypes.PATERNAL_BROTHER,
          countField: "paternalBrothers",
        },
      ];

      /**
       * Определяет, кто является асаба
       * @param {object} heirs - состояние наследников
       * @returns {object|null}
       */
      function determineAsaba(heirs) {
        for (const asabaInfo of AsabaPriority) {
          const count = heirs[asabaInfo.countField];
          if (!count || count === 0 || count === false) continue;

          // Проверяем блокировку
          if (asabaInfo.key === "grandsonsFromSon" && heirs.sons > 0) continue;
          if (asabaInfo.key === "paternalGrandfather" && heirs.father) continue;
          if (
            (asabaInfo.key === "fullBrothers" ||
              asabaInfo.key === "paternalBrothers") &&
            (heirs.father || heirs.sons > 0 || heirs.grandsonsFromSon > 0)
          )
            continue;
          if (asabaInfo.key === "paternalBrothers" && heirs.fullBrothers > 0)
            continue;

          const asabaCount = count === true ? 1 : count;
          let femaleCount = 0;
          let femaleType = null;

          if (asabaInfo.key === "sons") {
            femaleCount = heirs.daughters || 0;
            femaleType = HeirTypes.DAUGHTER;
          } else if (asabaInfo.key === "grandsonsFromSon") {
            femaleCount = heirs.granddaughtersFromSon || 0;
            femaleType = HeirTypes.GRANDDAUGHTER_FROM_SON;
          } else if (asabaInfo.key === "fullBrothers") {
            femaleCount = heirs.fullSisters || 0;
            femaleType = HeirTypes.FULL_SISTER;
          } else if (asabaInfo.key === "paternalBrothers") {
            femaleCount = heirs.paternalSisters || 0;
            femaleType = HeirTypes.PATERNAL_SISTER;
          }

          return {
            maleType: asabaInfo.type,
            maleCount: asabaCount,
            femaleType,
            femaleCount,
            hasFemales: femaleCount > 0,
            key: asabaInfo.key,
          };
        }
        return null;
      }

      /**
       * Рассчитывает сумму фиксированных долей
       * @param {object} heirs - состояние наследников
       * @returns {Fraction}
       */
      function calculateFixedSharesTotal(heirs) {
        let total = new Fraction(0, 1);

        // Супруг
        if (heirs.husband) {
          total = total.add(HeirTypes.HUSBAND.getShare(heirs));
        } else if (heirs.wife) {
          total = total.add(HeirTypes.WIFE.getShare(heirs));
        }

        // Мать
        if (heirs.mother) {
          total = total.add(HeirTypes.MOTHER.getShare(heirs));
        }

        // Отец - только фиксированная часть
        if (heirs.father) {
          const fatherShare = HeirTypes.FATHER.getShare(heirs);
          if (fatherShare) total = total.add(fatherShare);
        }

        // Дед - только если нет отца
        if (heirs.paternalGrandfather && !heirs.father) {
          const grandfatherShare =
            HeirTypes.PATERNAL_GRANDFATHER.getShare(heirs);
          if (grandfatherShare) total = total.add(grandfatherShare);
        }

        // Бабушки - только если нет матери
        if (
          (heirs.paternalGrandmother || heirs.maternalGrandmother) &&
          !heirs.mother
        ) {
          total = total.add(new Fraction(1, 6));
        }

        // Дочери - только фиксированная доля (если нет сыновей)
        if (heirs.daughters > 0 && heirs.sons === 0) {
          const daughterShare = HeirTypes.DAUGHTER.getShare(heirs);
          if (daughterShare) total = total.add(daughterShare);
        }

        // Внучки от сына - только если нет сыновей
        if (heirs.granddaughtersFromSon > 0 && heirs.sons === 0) {
          const granddaughterShare =
            HeirTypes.GRANDDAUGHTER_FROM_SON.getShare(heirs);
          if (granddaughterShare && !granddaughterShare.isZero()) {
            total = total.add(granddaughterShare);
          }
        }

        // Родные сестры - только если нет братьев и не заблокированы
        if (
          heirs.fullSisters > 0 &&
          heirs.fullBrothers === 0 &&
          !heirs.father &&
          heirs.sons === 0 &&
          heirs.grandsonsFromSon === 0
        ) {
          const sisterShare = HeirTypes.FULL_SISTER.getShare(heirs);
          if (sisterShare) total = total.add(sisterShare);
        }

        // Единокровные сестры
        if (
          heirs.paternalSisters > 0 &&
          heirs.paternalBrothers === 0 &&
          heirs.fullBrothers === 0 &&
          !heirs.father &&
          heirs.sons === 0 &&
          heirs.grandsonsFromSon === 0
        ) {
          const paternalSisterShare = HeirTypes.PATERNAL_SISTER.getShare(heirs);
          if (paternalSisterShare && !paternalSisterShare.isZero()) {
            total = total.add(paternalSisterShare);
          }
        }

        // Единоутробные братья/сестры (при каляля)
        if (!heirs.father && !hasChildren(heirs)) {
          const totalMaternal =
            (heirs.maternalBrothers || 0) + (heirs.maternalSisters || 0);
          if (totalMaternal > 0) {
            const maternalShare =
              totalMaternal === 1 ? new Fraction(1, 6) : new Fraction(1, 3);
            total = total.add(maternalShare);
          }
        }

        return total;
      }

      /**
       * Рассчитывает остаток после фиксированных долей
       * @param {object} heirs - состояние наследников
       * @returns {Fraction}
       */
      function calculateRemainder(heirs) {
        const fixedTotal = calculateFixedSharesTotal(heirs);
        const one = new Fraction(1, 1);
        const remainder = one.subtract(fixedTotal);
        return remainder.greaterThan(new Fraction(0, 1))
          ? remainder
          : new Fraction(0, 1);
      }

      /**
       * Проверяет, нужно ли применять аль-Авль
       * @param {object} heirs - состояние наследников
       * @returns {boolean}
       */
      function needsAwl(heirs) {
        const fixedTotal = calculateFixedSharesTotal(heirs);
        return fixedTotal.greaterThan(new Fraction(1, 1));
      }

      /**
       * Рассчитывает коэффициент Авль
       * @param {object} heirs - состояние наследников
       * @returns {Fraction}
       */
      function calculateAwlRatio(heirs) {
        const fixedTotal = calculateFixedSharesTotal(heirs);
        if (!fixedTotal.greaterThan(new Fraction(1, 1))) {
          return new Fraction(1, 1);
        }
        return new Fraction(1, 1).divide(fixedTotal);
      }

      /**
       * Проверяет, нужно ли применять ар-Радд
       * @param {object} heirs - состояние наследников
       * @returns {boolean}
       */
      function needsRadd(heirs) {
        const remainder = calculateRemainder(heirs);
        const asabaInfo = determineAsaba(heirs);
        return remainder.greaterThan(new Fraction(0, 1)) && !asabaInfo;
      }

      /**
       * Проверяет случай аль-Умарийятайн
       * @param {object} heirs - состояние наследников
       * @returns {object|null}
       */
      function checkUmariyyatan(heirs) {
        const hasSpouse = heirs.husband || heirs.wife;
        if (!hasSpouse || !heirs.father || !heirs.mother) return null;
        if (
          heirs.sons > 0 ||
          heirs.daughters > 0 ||
          heirs.grandsonsFromSon > 0 ||
          heirs.granddaughtersFromSon > 0
        )
          return null;
        if (
          heirs.fullBrothers > 0 ||
          heirs.fullSisters > 0 ||
          heirs.paternalBrothers > 0 ||
          heirs.paternalSisters > 0 ||
          heirs.maternalBrothers > 0 ||
          heirs.maternalSisters > 0
        )
          return null;
        if (
          heirs.paternalGrandfather ||
          heirs.paternalGrandmother ||
          heirs.maternalGrandmother
        )
          return null;

        return {
          applies: true,
          caseNumber: heirs.husband ? 1 : 2,
          description: heirs.husband
            ? "Случай аль-Умарийятайн с мужем: муж получает 1/2, мать — 1/3 от остатка, отец — остаток"
            : "Случай аль-Умарийятайн с женой: жена получает 1/4, мать — 1/3 от остатка, отец — остаток",
        };
      }

      // ========================================
      // State Management
      // ========================================
      const AppState = {
        // Флаг прохождения предварительного этапа
        obligationsAccepted: false,

        // Сумма наследства
        totalEstate: 0,

        // Выбранные наследники
        heirs: {
          // Супруги
          husband: false,
          wife: false,
          wifeCount: 1,

          // Потомки
          sons: 0,
          daughters: 0,
          grandsonsFromSon: 0,
          granddaughtersFromSon: 0,

          // Предки
          father: false,
          mother: false,
          paternalGrandfather: false,
          paternalGrandmother: false,
          maternalGrandmother: false,

          // Братья и сестры
          fullBrothers: 0,
          fullSisters: 0,
          paternalBrothers: 0,
          paternalSisters: 0,
          maternalBrothers: 0,
          maternalSisters: 0,
          nephewsFullBrothers: 0,
          nephewsPaternalBrothers: 0,
          unclesFull: 0,
          unclesPaternal: 0,
        },

        // Результаты расчета
        results: null,

        // Примененные особые правила
        appliedRules: {
          awl: false,
          radd: false,
          umariyyatan: false,
        },

        // Настройки распределения остатка
        remainderDestination: "treasury", // treasury | charity
      };

      // ========================================
      // DOM Elements
      // ========================================
      const DOM = {
        // Modal elements
        obligationsModal: document.getElementById("obligations-modal"),
        obligationsCheckbox: document.getElementById("obligations-checkbox"),
        continueBtn: document.getElementById("continue-btn"),

        // Main sections
        calculatorMain: document.getElementById("calculator-main"),
        resultsSection: document.getElementById("results-section"),

        // Form elements - Estate
        estateAmount: document.getElementById("estate-amount"),
        estateError: document.getElementById("estate-error"),

        // Form elements - Spouse
        spouseRadios: document.querySelectorAll('input[name="spouse"]'),
        spouseHint: document.getElementById("spouse-hint"),
        wifeCountGroup: document.getElementById("wife-count-group"),
        wifeCount: document.getElementById("wife-count"),

        // Form elements - Descendants
        sons: document.getElementById("sons"),
        daughters: document.getElementById("daughters"),
        grandsonsFromSon: document.getElementById("grandsons-from-son"),
        granddaughtersFromSon: document.getElementById(
          "granddaughters-from-son"
        ),
        grandsonsBlocked: document.getElementById("grandsons-blocked"),
        granddaughtersBlocked: document.getElementById(
          "granddaughters-blocked"
        ),

        // Form elements - Ancestors
        father: document.getElementById("father"),
        mother: document.getElementById("mother"),
        paternalGrandfather: document.getElementById("paternal-grandfather"),
        paternalGrandmother: document.getElementById("paternal-grandmother"),
        maternalGrandmother: document.getElementById("maternal-grandmother"),
        grandfatherBlocked: document.getElementById("grandfather-blocked"),
        paternalGrandmotherBlocked: document.getElementById(
          "paternal-grandmother-blocked"
        ),

        // Form elements - Siblings
        fullBrothers: document.getElementById("full-brothers"),
        fullSisters: document.getElementById("full-sisters"),
        paternalBrothers: document.getElementById("paternal-brothers"),
        paternalSisters: document.getElementById("paternal-sisters"),
        maternalBrothers: document.getElementById("maternal-brothers"),
        maternalSisters: document.getElementById("maternal-sisters"),
        fullBrothersBlocked: document.getElementById("full-brothers-blocked"),
        fullSistersBlocked: document.getElementById("full-sisters-blocked"),
        paternalBrothersBlocked: document.getElementById(
          "paternal-brothers-blocked"
        ),
        paternalSistersBlocked: document.getElementById(
          "paternal-sisters-blocked"
        ),
        maternalBrothersBlocked: document.getElementById(
          "maternal-brothers-blocked"
        ),
        maternalSistersBlocked: document.getElementById(
          "maternal-sisters-blocked"
        ),
        nephewsFullBrothers: document.getElementById("nephews-full-brothers"),
        nephewsPaternalBrothers: document.getElementById(
          "nephews-paternal-brothers"
        ),
        unclesFull: document.getElementById("uncles-full"),
        unclesPaternal: document.getElementById("uncles-paternal"),
        distantAsabaBlocked: document.getElementById("distant-asaba-blocked"),

        // Calculate button
        calculateBtn: document.getElementById("calculate-btn"),
      };

      // ========================================
      // Modal Controller (Шаг 0)
      // ========================================
      const ModalController = {
        /**
         * Инициализация модального окна
         * Показывает модальное окно при загрузке страницы
         */
        init() {
          // Показать модальное окно при загрузке
          this.showModal();

          // Привязать обработчики событий
          this.bindEvents();
        },

        /**
         * Показать модальное окно
         * Блокирует доступ к калькулятору до подтверждения
         */
        showModal() {
          if (DOM.obligationsModal) {
            if (typeof DOM.obligationsModal.showModal === "function") {
              DOM.obligationsModal.showModal();
            } else {
              // jsdom fallback: mark dialog as open when showModal is missing
              DOM.obligationsModal.setAttribute("open", "true");
            }
          }
        },

        /**
         * Скрыть модальное окно
         */
        hideModal() {
          if (DOM.obligationsModal) {
            console.log("hideModal: Starting to hide modal");

            // Убеждаемся, что состояние обновлено
            AppState.obligationsAccepted = true;
            console.log("hideModal: AppState.obligationsAccepted set to true");

            // Принудительно закрываем модальное окно
            if (typeof DOM.obligationsModal.close === "function") {
              DOM.obligationsModal.close();
              console.log("hideModal: modal.close() called");
            } else {
              DOM.obligationsModal.removeAttribute("open");
              console.log(
                "hideModal: modal.close() missing, removed open attr"
              );
            }

            // ПРИНУДИТЕЛЬНО скрываем через CSS
            DOM.obligationsModal.style.display = "none";
            DOM.obligationsModal.style.visibility = "hidden";
            DOM.obligationsModal.style.opacity = "0";
            DOM.obligationsModal.style.pointerEvents = "none";

            // Убираем атрибут open если он есть
            DOM.obligationsModal.removeAttribute("open");

            console.log("hideModal: Forced CSS hiding applied");

            // Дополнительная проверка - если модальное окно все еще открыто
            setTimeout(() => {
              if (DOM.obligationsModal.open) {
                console.log("hideModal: Modal still open, forcing close");
                DOM.obligationsModal.open = false;
                DOM.obligationsModal.style.display = "none";
              } else {
                console.log("hideModal: Modal successfully closed");
              }
            }, 100);
          } else {
            console.log("hideModal: DOM.obligationsModal not found");
          }
        },

        /**
         * Привязка обработчиков событий
         */
        bindEvents() {
          console.log("bindEvents called");
          console.log("DOM elements check:");
          console.log("- obligationsCheckbox:", DOM.obligationsCheckbox);
          console.log("- continueBtn:", DOM.continueBtn);
          console.log("- obligationsModal:", DOM.obligationsModal);

          // Обработчик изменения чекбокса
          if (DOM.obligationsCheckbox) {
            console.log("Binding checkbox change event");
            DOM.obligationsCheckbox.addEventListener("change", (e) => {
              console.log("Checkbox change event fired");
              this.handleCheckboxChange(e.target.checked);
            });
          } else {
            console.error("obligationsCheckbox not found!");
          }

          // Обработчик кнопки "Продолжить"
          if (DOM.continueBtn) {
            console.log("Binding continue button click event");
            DOM.continueBtn.addEventListener("click", (e) => {
              console.log("Continue button click event fired");
              e.preventDefault(); // Предотвращаем любое стандартное поведение
              this.handleContinue();
            });
          } else {
            console.error("continueBtn not found!");
          }

          // Предотвращаем закрытие модального окна по Escape до подтверждения
          if (DOM.obligationsModal) {
            DOM.obligationsModal.addEventListener("cancel", (e) => {
              if (!AppState.obligationsAccepted) {
                e.preventDefault();
              }
            });

            // Предотвращаем закрытие по клику на backdrop, но не мешаем программному закрытию
            DOM.obligationsModal.addEventListener("click", (e) => {
              if (
                e.target === DOM.obligationsModal &&
                !AppState.obligationsAccepted &&
                e.isTrusted // Только для пользовательских кликов, не программных
              ) {
                e.preventDefault();
              }
            });
          }
        },

        /**
         * Обработчик изменения состояния чекбокса
         * @param {boolean} isChecked - состояние чекбокса
         */
        handleCheckboxChange(isChecked) {
          console.log("handleCheckboxChange called with:", isChecked);
          console.log("Continue button element:", DOM.continueBtn);

          if (DOM.continueBtn) {
            DOM.continueBtn.disabled = !isChecked;
            console.log("Button disabled set to:", !isChecked);
          } else {
            console.error("Continue button not found in handleCheckboxChange!");
          }
        },

        /**
         * Обработчик нажатия кнопки "Продолжить"
         * Переход к калькулятору после подтверждения
         */
        handleContinue() {
          console.log("handleContinue called");
          console.log("Checkbox element:", DOM.obligationsCheckbox);
          console.log(
            "Checkbox checked:",
            DOM.obligationsCheckbox
              ? DOM.obligationsCheckbox.checked
              : "checkbox not found"
          );
          console.log("Button element:", DOM.continueBtn);
          console.log(
            "Button disabled:",
            DOM.continueBtn ? DOM.continueBtn.disabled : "button not found"
          );

          if (DOM.obligationsCheckbox && DOM.obligationsCheckbox.checked) {
            console.log("Continue button clicked, checkbox is checked");

            // Обновляем состояние ПЕРЕД любыми действиями с модальным окном
            AppState.obligationsAccepted = true;
            console.log("AppState.obligationsAccepted set to true");

            // Скрываем модальное окно
            this.hideModal();
            console.log("hideModal() called");

            // Показываем калькулятор с небольшой задержкой для плавности
            setTimeout(() => {
              this.showCalculator();
              console.log("showCalculator() called");
            }, 150);
          } else {
            console.log(
              "Continue button clicked but checkbox is not checked or not found"
            );
            if (!DOM.obligationsCheckbox) {
              console.error("Checkbox element not found!");
            } else if (!DOM.obligationsCheckbox.checked) {
              console.error("Checkbox is not checked!");
            }
          }
        },

        /**
         * Показать основной интерфейс калькулятора
         */
        showCalculator() {
          if (DOM.calculatorMain) {
            DOM.calculatorMain.classList.remove("hidden");

            // Плавная анимация появления на мобильных
            if (globalThis.innerWidth <= 767) {
              DOM.calculatorMain.style.opacity = "0";
              DOM.calculatorMain.style.transform = "translateY(20px)";

              setTimeout(() => {
                DOM.calculatorMain.style.transition =
                  "opacity 0.3s ease, transform 0.3s ease";
                DOM.calculatorMain.style.opacity = "1";
                DOM.calculatorMain.style.transform = "translateY(0)";
              }, 50);
            }
          }
        },
      };

      // ========================================
      // Validation Engine
      // ========================================
      const ValidationEngine = {
        /**
         * Форматирует число с разделителями тысяч
         * @param {number|string} value - значение для форматирования
         * @returns {string} - отформатированная строка
         */
        formatNumber(value) {
          if (value === "" || value === null || value === undefined) return "";
          const num = Number.parseFloat(
            String(value).replaceAll(/\s/g, "").replaceAll(",", ".")
          );
          if (Number.isNaN(num)) return "";
          return new Intl.NumberFormat("ru-RU").format(num);
        },

        /**
         * Парсит отформатированное число обратно в число
         * @param {string} value - отформатированная строка
         * @returns {number} - числовое значение
         */
        parseFormattedNumber(value) {
          if (!value) return 0;
          // Удаляем пробелы (разделители тысяч) и заменяем запятую на точку
          const cleaned = String(value)
            .replaceAll(/\s/g, "")
            .replaceAll(",", ".");
          const num = Number.parseFloat(cleaned);
          return Number.isNaN(num) ? 0 : num;
        },

        /**
         * Валидирует сумму наследства
         * @param {string} value - введенное значение
         * @returns {object} - результат валидации {valid: boolean, error: string, value: number}
         */
        validateEstateAmount(value) {
          if (!value || value.trim() === "") {
            return {
              valid: false,
              error: "Пожалуйста, введите сумму наследства",
              value: 0,
            };
          }

          const num = this.parseFormattedNumber(value);

          if (Number.isNaN(num)) {
            return {
              valid: false,
              error: "Введите корректное число",
              value: 0,
            };
          }

          if (num < 0) {
            return {
              valid: false,
              error: "Сумма не может быть отрицательной",
              value: 0,
            };
          }

          if (num === 0) {
            return {
              valid: false,
              error: "Сумма должна быть больше нуля",
              value: 0,
            };
          }

          return { valid: true, error: "", value: num };
        },

        /**
         * Валидирует целое неотрицательное число
         * @param {string|number} value - введенное значение
         * @returns {object} - результат валидации {valid: boolean, value: number}
         */
        validateNonNegativeInteger(value) {
          const num = Number.parseInt(value, 10);
          if (Number.isNaN(num) || num < 0) {
            return { valid: false, value: 0 };
          }
          return { valid: true, value: Math.floor(num) };
        },

        /**
         * Валидирует количество жен (1-4)
         * @param {string|number} value - введенное значение
         * @returns {object} - результат валидации {valid: boolean, value: number}
         */
        validateWifeCount(value) {
          const num = Number.parseInt(value, 10);
          if (Number.isNaN(num) || num < 1) {
            return { valid: true, value: 1 };
          }
          if (num > 4) {
            return { valid: true, value: 4 };
          }
          return { valid: true, value: num };
        },
      };

      // ========================================
      // Form Controller
      // ========================================
      const FormController = {
        /**
         * Инициализация контроллера формы
         */
        init() {
          this.bindEvents();
          this.updateSpouseHint();
        },

        /**
         * Привязка обработчиков событий
         */
        bindEvents() {
          // Обработчик ввода суммы наследства
          if (DOM.estateAmount) {
            DOM.estateAmount.addEventListener("input", (e) => {
              this.handleEstateInput(e);
            });

            DOM.estateAmount.addEventListener("blur", (e) => {
              this.handleEstateBlur(e);
            });

            // Предотвращаем ввод нечисловых символов
            DOM.estateAmount.addEventListener("keypress", (e) => {
              this.handleEstateKeypress(e);
            });
          }

          // Обработчики выбора супруга
          DOM.spouseRadios.forEach((radio) => {
            radio.addEventListener("change", (e) => {
              this.handleSpouseChange(e);
            });
          });

          // Обработчик количества жен
          if (DOM.wifeCount) {
            DOM.wifeCount.addEventListener("change", (e) => {
              this.handleWifeCountChange(e);
            });

            DOM.wifeCount.addEventListener("blur", (e) => {
              this.handleWifeCountChange(e);
            });
          }

          // Обработчики полей потомков
          this.bindDescendantEvents();

          // Обработчики полей предков
          this.bindAncestorEvents();

          // Обработчики полей братьев/сестер
          this.bindSiblingEvents();
        },

        /**
         * Привязка событий для полей потомков
         */
        bindDescendantEvents() {
          const descendantFields = [
            DOM.sons,
            DOM.daughters,
            DOM.grandsonsFromSon,
            DOM.granddaughtersFromSon,
          ];

          descendantFields.forEach((field) => {
            if (field) {
              field.addEventListener("change", (e) => {
                this.handleNumberFieldChange(e, field.id);
              });

              field.addEventListener("blur", (e) => {
                this.handleNumberFieldChange(e, field.id);
              });
            }
          });
        },

        /**
         * Привязка событий для полей предков
         */
        bindAncestorEvents() {
          const ancestorCheckboxes = [
            DOM.father,
            DOM.mother,
            DOM.paternalGrandfather,
            DOM.paternalGrandmother,
            DOM.maternalGrandmother,
          ];

          ancestorCheckboxes.forEach((checkbox) => {
            if (checkbox) {
              checkbox.addEventListener("change", (e) => {
                this.handleAncestorChange(e);
              });
            }
          });
        },

        /**
         * Привязка событий для полей братьев/сестер
         */
        bindSiblingEvents() {
          const siblingFields = [
            DOM.fullBrothers,
            DOM.fullSisters,
            DOM.paternalBrothers,
            DOM.paternalSisters,
            DOM.maternalBrothers,
            DOM.maternalSisters,
            DOM.nephewsFullBrothers,
            DOM.nephewsPaternalBrothers,
            DOM.unclesFull,
            DOM.unclesPaternal,
          ];

          siblingFields.forEach((field) => {
            if (field) {
              field.addEventListener("change", (e) => {
                this.handleNumberFieldChange(e, field.id);
              });

              field.addEventListener("blur", (e) => {
                this.handleNumberFieldChange(e, field.id);
              });
            }
          });
        },

        /**
         * Обработчик ввода суммы наследства
         * @param {Event} e - событие ввода
         */
        handleEstateInput(e) {
          const input = e.target;
          let value = input.value;

          // Сохраняем позицию курсора
          const cursorPos = input.selectionStart;
          const oldLength = value.length;

          // Удаляем все символы кроме цифр, точки и запятой
          value = value.replaceAll(/[^\d.,\s]/g, "");

          // Обновляем значение
          input.value = value;

          // Восстанавливаем позицию курсора
          const newLength = value.length;
          const newCursorPos = cursorPos - (oldLength - newLength);
          input.setSelectionRange(newCursorPos, newCursorPos);

          // Очищаем ошибку при вводе
          this.clearEstateError();

          // Добавляем визуальную обратную связь на мобильных
          if (globalThis.innerWidth <= 767) {
            input.style.borderColor = "var(--color-primary-light)";
            setTimeout(() => {
              input.style.borderColor = "";
            }, 300);
          }
        },

        /**
         * Обработчик потери фокуса поля суммы
         * @param {Event} e - событие blur
         */
        handleEstateBlur(e) {
          const input = e.target;
          const validation = ValidationEngine.validateEstateAmount(input.value);

          if (validation.valid) {
            // Форматируем число с разделителями тысяч
            input.value = ValidationEngine.formatNumber(validation.value);
            AppState.totalEstate = validation.value;
            this.clearEstateError();
          } else if (input.value.trim() !== "") {
            this.showEstateError(validation.error);
          }
        },

        /**
         * Обработчик нажатия клавиш в поле суммы
         * @param {KeyboardEvent} e - событие keypress
         */
        handleEstateKeypress(e) {
          // Разрешаем: цифры, точку, запятую, backspace, delete, стрелки
          const allowedKeys = [
            "0",
            "1",
            "2",
            "3",
            "4",
            "5",
            "6",
            "7",
            "8",
            "9",
            ".",
            ",",
          ];

          if (!allowedKeys.includes(e.key) && !e.ctrlKey && !e.metaKey) {
            // Разрешаем управляющие клавиши
            if (
              e.key !== "Backspace" &&
              e.key !== "Delete" &&
              e.key !== "ArrowLeft" &&
              e.key !== "ArrowRight" &&
              e.key !== "Tab" &&
              e.key !== "Enter"
            ) {
              e.preventDefault();
            }
          }
        },

        /**
         * Показать ошибку суммы наследства
         * @param {string} message - текст ошибки
         */
        showEstateError(message) {
          if (DOM.estateError) {
            DOM.estateError.textContent = message;
            DOM.estateError.style.display = "block";
          }
          if (DOM.estateAmount) {
            DOM.estateAmount.style.borderColor = "var(--color-error)";
          }
        },

        /**
         * Очистить ошибку суммы наследства
         */
        clearEstateError() {
          if (DOM.estateError) {
            DOM.estateError.textContent = "";
            DOM.estateError.style.display = "none";
          }
          if (DOM.estateAmount) {
            DOM.estateAmount.style.borderColor = "";
          }
        },

        /**
         * Обработчик изменения выбора супруга
         * @param {Event} e - событие change
         */
        handleSpouseChange(e) {
          const value = e.target.value;

          // Обновляем состояние
          AppState.heirs.husband = value === "husband";
          AppState.heirs.wife = value === "wife";

          // Показываем/скрываем поле количества жен
          if (DOM.wifeCountGroup) {
            if (value === "wife") {
              DOM.wifeCountGroup.classList.remove("hidden");
            } else {
              DOM.wifeCountGroup.classList.add("hidden");
              AppState.heirs.wifeCount = 1;
              if (DOM.wifeCount) {
                DOM.wifeCount.value = 1;
              }
            }
          }

          // Обновляем подсказку о доле
          this.updateSpouseHint();
        },

        /**
         * Обработчик изменения количества жен
         * @param {Event} e - событие change
         */
        handleWifeCountChange(e) {
          const validation = ValidationEngine.validateWifeCount(e.target.value);
          e.target.value = validation.value;
          AppState.heirs.wifeCount = validation.value;
        },

        /**
         * Обновить подсказку о доле супруга
         */
        updateSpouseHint() {
          if (!DOM.spouseHint) return;

          const hasChildren =
            AppState.heirs.sons > 0 ||
            AppState.heirs.daughters > 0 ||
            AppState.heirs.grandsonsFromSon > 0 ||
            AppState.heirs.granddaughtersFromSon > 0;

          if (AppState.heirs.husband) {
            DOM.spouseHint.textContent = hasChildren
              ? "Доля мужа: 1/4 (при наличии детей)"
              : "Доля мужа: 1/2 (при отсутствии детей)";
            DOM.spouseHint.style.display = "block";
          } else if (AppState.heirs.wife) {
            DOM.spouseHint.textContent = hasChildren
              ? "Доля жены/жен: 1/8 (при наличии детей)"
              : "Доля жены/жен: 1/4 (при отсутствии детей)";
            DOM.spouseHint.style.display = "block";
          } else {
            DOM.spouseHint.textContent = "";
            DOM.spouseHint.style.display = "none";
          }
        },

        /**
         * Обработчик изменения числового поля
         * @param {Event} e - событие change
         * @param {string} fieldId - идентификатор поля
         */
        handleNumberFieldChange(e, fieldId) {
          const validation = ValidationEngine.validateNonNegativeInteger(
            e.target.value
          );
          e.target.value = validation.value;

          // Обновляем состояние в зависимости от поля
          this.updateStateFromField(fieldId, validation.value);

          // Обновляем подсказку о доле супруга при изменении потомков
          const descendantFields = [
            "sons",
            "daughters",
            "grandsons-from-son",
            "granddaughters-from-son",
          ];
          if (descendantFields.includes(fieldId)) {
            this.updateSpouseHint();
          }

          // Обновляем блокировки при изменении полей, влияющих на блокировку
          const blockingTriggerFields = [
            "sons",
            "daughters",
            "grandsons-from-son",
            "granddaughters-from-son",
            "full-brothers",
            "full-sisters",
            "paternal-brothers",
            "paternal-sisters",
            "nephews-full-brothers",
            "nephews-paternal-brothers",
            "uncles-full",
            "uncles-paternal",
          ];
          if (blockingTriggerFields.includes(fieldId)) {
            BlockingController.updateAllBlockings();
            this.updateDistantAsabaAvailability();
          }

          // Добавляем тактильную обратную связь на мобильных
          if (MobileUtils.isMobile() && MobileUtils.isTouchDevice()) {
            // Легкая вибрация при изменении значения (если поддерживается)
            if (navigator.vibrate && validation.value !== 0) {
              navigator.vibrate(50);
            }

            // Визуальная обратная связь
            e.target.style.backgroundColor = "var(--color-bg-alt)";
            setTimeout(() => {
              e.target.style.backgroundColor = "";
            }, 200);
          }
        },

        /**
         * Обновить состояние из поля формы
         * @param {string} fieldId - идентификатор поля
         * @param {number} value - значение
         */
        updateStateFromField(fieldId, value) {
          const fieldMapping = {
            sons: "sons",
            daughters: "daughters",
            "grandsons-from-son": "grandsonsFromSon",
            "granddaughters-from-son": "granddaughtersFromSon",
            "full-brothers": "fullBrothers",
            "full-sisters": "fullSisters",
            "paternal-brothers": "paternalBrothers",
            "paternal-sisters": "paternalSisters",
            "maternal-brothers": "maternalBrothers",
            "maternal-sisters": "maternalSisters",
            "nephews-full-brothers": "nephewsFullBrothers",
            "nephews-paternal-brothers": "nephewsPaternalBrothers",
            "uncles-full": "unclesFull",
            "uncles-paternal": "unclesPaternal",
          };

          const stateKey = fieldMapping[fieldId];
          if (stateKey) {
            console.log(
              `=== ОТЛАДКА: Обновляем AppState.heirs.${stateKey} = ${value} ===`
            );
            AppState.heirs[stateKey] = value;
            console.log("AppState.heirs после обновления:", AppState.heirs);
          } else {
            console.warn(
              `=== ОТЛАДКА: Не найден маппинг для fieldId: ${fieldId} ===`
            );
          }
        },

        /**
         * Обработчик изменения чекбоксов предков
         * @param {Event} e - событие change
         */
        handleAncestorChange(e) {
          const checkbox = e.target;
          const fieldMapping = {
            father: "father",
            mother: "mother",
            "paternal-grandfather": "paternalGrandfather",
            "paternal-grandmother": "paternalGrandmother",
            "maternal-grandmother": "maternalGrandmother",
          };

          const stateKey = fieldMapping[checkbox.id];
          if (stateKey) {
            console.log(
              `=== ОТЛАДКА: Обновляем AppState.heirs.${stateKey} = ${checkbox.checked} ===`
            );
            AppState.heirs[stateKey] = checkbox.checked;
            console.log("AppState.heirs после обновления:", AppState.heirs);
          } else {
            console.warn(
              `=== ОТЛАДКА: Не найден маппинг для checkbox.id: ${checkbox.id} ===`
            );
          }

          // Обновляем блокировки при изменении отца, матери или деда
          if (
            checkbox.id === "father" ||
            checkbox.id === "mother" ||
            checkbox.id === "paternal-grandfather"
          ) {
            BlockingController.updateAllBlockings();
            this.updateDistantAsabaAvailability();
          }
        },

        updateDistantAsabaAvailability() {
          const heirs = AppState.heirs;

          // Проверяем наличие более близких асаба, которые блокируют ВСЕХ дальних
          const hasCloserAgnates =
            heirs.sons > 0 ||
            heirs.grandsonsFromSon > 0 ||
            heirs.father ||
            heirs.paternalGrandfather ||
            heirs.fullBrothers > 0 ||
            heirs.paternalBrothers > 0;

          if (hasCloserAgnates) {
            this.disableDistantAsabaInputs(
              true,
              "Дальние асаба заблокированы: есть более близкие мужские наследники (сын/внук/отец/дед/братья)."
            );
          } else {
            this.disableDistantAsabaInputs(false);
            // Дополнительная логика: племянники блокируют дядей
            this.updateUnclesAvailability();
          }
        },

        /**
         * Обновить доступность полей дядей на основе наличия племянников
         * Племянники (сыновья братьев) блокируют дядей согласно правилам асаба
         */
        updateUnclesAvailability() {
          const heirs = AppState.heirs;

          // Сыновья полнородных братьев блокируют всех дядей
          const hasNephewsFromFullBrothers = heirs.nephewsFullBrothers > 0;

          // Сыновья единокровных братьев блокируют единокровных дядей
          const hasNephewsFromPaternalBrothers =
            heirs.nephewsPaternalBrothers > 0;

          // Полнородные дяди блокируются сыновьями полнородных братьев
          if (DOM.unclesFull) {
            if (hasNephewsFromFullBrothers) {
              DOM.unclesFull.disabled = true;
              DOM.unclesFull.classList.add("input--disabled");
            } else {
              DOM.unclesFull.disabled = false;
              DOM.unclesFull.classList.remove("input--disabled");
            }
          }

          // Единокровные дяди блокируются сыновьями полнородных и единокровных братьев
          if (DOM.unclesPaternal) {
            if (hasNephewsFromFullBrothers || hasNephewsFromPaternalBrothers) {
              DOM.unclesPaternal.disabled = true;
              DOM.unclesPaternal.classList.add("input--disabled");
            } else {
              DOM.unclesPaternal.disabled = false;
              DOM.unclesPaternal.classList.remove("input--disabled");
            }
          }

          // Сыновья единокровных братьев блокируются сыновьями полнородных братьев
          if (DOM.nephewsPaternalBrothers) {
            if (hasNephewsFromFullBrothers) {
              DOM.nephewsPaternalBrothers.disabled = true;
              DOM.nephewsPaternalBrothers.classList.add("input--disabled");
            } else {
              DOM.nephewsPaternalBrothers.disabled = false;
              DOM.nephewsPaternalBrothers.classList.remove("input--disabled");
            }
          }

          // Обновляем подсказку о блокировке
          if (DOM.distantAsabaBlocked) {
            let blockingReasons = [];
            if (hasNephewsFromFullBrothers) {
              blockingReasons.push(
                "Сыновья полнородных братьев блокируют: единокровных племянников и всех дядей"
              );
            } else if (hasNephewsFromPaternalBrothers) {
              blockingReasons.push(
                "Сыновья единокровных братьев блокируют: единокровных дядей"
              );
            }
            DOM.distantAsabaBlocked.textContent = blockingReasons.join(". ");
          }
        },

        /**
         * Блокировка/разблокировка полей дальних асааба
         * @param {boolean} disabled - заблокировать или разблокировать
         * @param {string} reason - причина блокировки
         */
        disableDistantAsabaInputs(disabled, reason = "") {
          const inputs = [
            DOM.nephewsFullBrothers,
            DOM.nephewsPaternalBrothers,
            DOM.unclesFull,
            DOM.unclesPaternal,
          ];
          inputs.forEach((el) => {
            if (!el) return;
            el.disabled = disabled;
            if (disabled) {
              el.classList.add("input--disabled");
            } else {
              el.classList.remove("input--disabled");
            }
          });
          if (DOM.distantAsabaBlocked) {
            DOM.distantAsabaBlocked.textContent = disabled ? reason : "";
          }
        },

        /**
         * Получить все данные формы
         * @returns {object} - данные формы
         */
        getFormData() {
          // Валидируем сумму
          const estateValidation = ValidationEngine.validateEstateAmount(
            DOM.estateAmount?.value || ""
          );

          return {
            totalEstate: estateValidation.value,
            estateValid: estateValidation.valid,
            estateError: estateValidation.error,
            heirs: { ...AppState.heirs },
          };
        },

        /**
         * Проверить, есть ли хотя бы один наследник
         * @returns {boolean}
         */
        hasAnyHeir() {
          const h = AppState.heirs;
          return (
            h.husband ||
            h.wife ||
            h.sons > 0 ||
            h.daughters > 0 ||
            h.grandsonsFromSon > 0 ||
            h.granddaughtersFromSon > 0 ||
            h.father ||
            h.mother ||
            h.paternalGrandfather ||
            h.paternalGrandmother ||
            h.maternalGrandmother ||
            h.fullBrothers > 0 ||
            h.fullSisters > 0 ||
            h.paternalBrothers > 0 ||
            h.paternalSisters > 0 ||
            h.maternalBrothers > 0 ||
            h.maternalSisters > 0
          );
        },
      };

      // ========================================
      // Blocking Controller (UI блокировка)
      // ========================================
      const BlockingController = {
        /**
         * Маппинг типов наследников на DOM элементы
         */
        fieldMapping: {
          paternalGrandfather: {
            input: () => DOM.paternalGrandfather,
            hint: () => DOM.grandfatherBlocked,
          },
          paternalGrandmother: {
            input: () => DOM.paternalGrandmother,
            hint: () => DOM.paternalGrandmotherBlocked,
          },
          grandsonsFromSon: {
            input: () => DOM.grandsonsFromSon,
            hint: () => DOM.grandsonsBlocked,
          },
          granddaughtersFromSon: {
            input: () => DOM.granddaughtersFromSon,
            hint: () => DOM.granddaughtersBlocked,
          },
          fullBrothers: {
            input: () => DOM.fullBrothers,
            hint: () => DOM.fullBrothersBlocked,
          },
          fullSisters: {
            input: () => DOM.fullSisters,
            hint: () => DOM.fullSistersBlocked,
          },
          paternalBrothers: {
            input: () => DOM.paternalBrothers,
            hint: () => DOM.paternalBrothersBlocked,
          },
          paternalSisters: {
            input: () => DOM.paternalSisters,
            hint: () => DOM.paternalSistersBlocked,
          },
          maternalBrothers: {
            input: () => DOM.maternalBrothers,
            hint: () => DOM.maternalBrothersBlocked,
          },
          maternalSisters: {
            input: () => DOM.maternalSisters,
            hint: () => DOM.maternalSistersBlocked,
          },
        },

        /**
         * Обновляет состояние блокировки всех полей в UI
         * Вызывается при изменении любого поля, влияющего на блокировку
         */
        updateAllBlockings() {
          const blockings = getAllBlockings(AppState.heirs);

          for (const [heirType, blocking] of Object.entries(blockings)) {
            this.updateFieldBlocking(heirType, blocking);
          }
        },

        /**
         * Обновляет состояние блокировки конкретного поля
         * @param {string} heirType - тип наследника
         * @param {object} blocking - { blocked: boolean, reason: string | null }
         */
        updateFieldBlocking(heirType, blocking) {
          const mapping = this.fieldMapping[heirType];
          if (!mapping) return;

          const input = mapping.input();
          const hint = mapping.hint();

          if (!input) return;

          if (blocking.blocked) {
            // Блокируем поле
            input.disabled = true;

            // Для чекбоксов снимаем галочку
            if (input.type === "checkbox") {
              input.checked = false;
              // Обновляем состояние
              this.updateStateForBlockedCheckbox(heirType);
            } else {
              // Для числовых полей обнуляем значение
              input.value = 0;
              // Обновляем состояние
              this.updateStateForBlockedNumber(heirType);
            }

            // Показываем подсказку о блокировке
            if (hint) {
              hint.textContent = blocking.reason || "Заблокировано";
              hint.style.display = "inline";
            }
          } else {
            // Разблокируем поле
            input.disabled = false;

            // Скрываем подсказку
            if (hint) {
              hint.textContent = "";
              hint.style.display = "none";
            }
          }
        },

        /**
         * Обновляет состояние для заблокированного чекбокса
         * @param {string} heirType - тип наследника
         */
        updateStateForBlockedCheckbox(heirType) {
          const stateMapping = {
            paternalGrandfather: "paternalGrandfather",
            paternalGrandmother: "paternalGrandmother",
          };

          const stateKey = stateMapping[heirType];
          if (stateKey) {
            AppState.heirs[stateKey] = false;
          }
        },

        /**
         * Обновляет состояние для заблокированного числового поля
         * @param {string} heirType - тип наследника
         */
        updateStateForBlockedNumber(heirType) {
          const stateMapping = {
            grandsonsFromSon: "grandsonsFromSon",
            granddaughtersFromSon: "granddaughtersFromSon",
            fullBrothers: "fullBrothers",
            fullSisters: "fullSisters",
            paternalBrothers: "paternalBrothers",
            paternalSisters: "paternalSisters",
            maternalBrothers: "maternalBrothers",
            maternalSisters: "maternalSisters",
          };

          const stateKey = stateMapping[heirType];
          if (stateKey) {
            AppState.heirs[stateKey] = 0;
          }
        },
      };

      // ========================================
      // Results Controller
      // ========================================
      const ResultsController = {
        /**
         * DOM элементы для результатов
         */
        elements: {
          resultsSection: document.getElementById("results-section"),
          specialNotices: document.getElementById("special-notices"),
          resultsTable: document.getElementById("results-table"),
          resultsBody: document.getElementById("results-body"),
          resultsCards: document.getElementById("results-cards"),
          remainderPanel: document.getElementById("remainder-panel"),
          remainderPercentage: document.getElementById("remainder-percentage"),
          remainderAmount: document.getElementById("remainder-amount"),
          remainderDestinationInputs: document.querySelectorAll(
            'input[name="remainder-destination"]'
          ),
          totalPercentage: document.getElementById("total-percentage"),
          totalAmount: document.getElementById("total-amount"),
          printBtn: document.getElementById("print-btn"),
          recalculateBtn: document.getElementById("recalculate-btn"),
        },

        /**
         * Инициализация контроллера результатов
         */
        init() {
          this.bindEvents();
        },

        /**
         * Привязка обработчиков событий
         */
        bindEvents() {
          // Обработчик кнопки печати
          if (this.elements.printBtn) {
            this.elements.printBtn.addEventListener("click", () => {
              this.handlePrint();
            });
          }

          // Обработчик кнопки нового расчета
          if (this.elements.recalculateBtn) {
            this.elements.recalculateBtn.addEventListener("click", () => {
              this.handleRecalculate();
            });
          }

          // Обработчик выбора направления остатка
          if (this.elements.remainderDestinationInputs?.length) {
            this.elements.remainderDestinationInputs.forEach((input) => {
              input.addEventListener("change", (event) => {
                const { value } = event.target;
                this.handleRemainderDestinationChange(value);
              });
            });
          }
        },

        /**
         * Отображает результаты расчета
         * @param {object} results - результаты расчета наследства
         */
        displayResults(results) {
          if (!results || !results.heirs) {
            console.error("Некорректные результаты расчета");
            return;
          }

          // Сохраняем результаты в состоянии
          AppState.results = results;

          // Показываем секцию результатов
          this.showResultsSection();

          // Отображаем уведомления об особых случаях
          this.displaySpecialNotices(results);

          // Заполняем таблицу результатов
          this.populateResultsTable(results);

          // Заполняем мобильные карточки
          this.populateResultsCards(results);

          // Отображаем остаток
          this.renderRemainder(results);

          // Обновляем итоговые значения
          this.updateTotals(results);
        },

        /**
         * Показывает секцию результатов
         */
        showResultsSection() {
          if (this.elements.resultsSection) {
            this.elements.resultsSection.classList.remove("hidden");

            // На мобильных устройствах добавляем плавную анимацию
            if (MobileUtils.isMobile()) {
              this.elements.resultsSection.style.opacity = "0";
              this.elements.resultsSection.style.transform = "translateY(20px)";

              setTimeout(() => {
                this.elements.resultsSection.style.transition =
                  "opacity 0.4s ease, transform 0.4s ease";
                this.elements.resultsSection.style.opacity = "1";
                this.elements.resultsSection.style.transform = "translateY(0)";
              }, 100);
            }

            // Прокручиваем к результатам с учетом мобильного интерфейса
            setTimeout(
              () => {
                this.elements.resultsSection.scrollIntoView({
                  behavior: "smooth",
                  block: MobileUtils.isMobile() ? "start" : "center",
                });
              },
              MobileUtils.isMobile() ? 200 : 0
            );
          }
        },

        /**
         * Скрывает секцию результатов
         */
        hideResultsSection() {
          if (this.elements.resultsSection) {
            this.elements.resultsSection.classList.add("hidden");
          }
        },

        /**
         * Отображает уведомления об особых случаях
         * @param {object} results - результаты расчета
         */
        displaySpecialNotices(results) {
          if (!this.elements.specialNotices) return;

          let noticesHtml = "";

          // Уведомление об аль-Авль
          if (results.awlApplied) {
            noticesHtml += `
              <div class="notice notice--warning">
                <span class="notice__icon">⚠️</span>
                <div>
                  <strong>Применено правило аль-Авль</strong>
                  <p>Сумма долей наследников превысила 100%. Все доли были пропорционально уменьшены для достижения справедливого распределения.</p>
                </div>
              </div>
            `;
          }

          // Уведомление об ар-Радд
          if (results.raddApplied) {
            const recipients =
              results.raddRecipients?.join(", ") || "наследники";
            noticesHtml += `
              <div class="notice notice--info">
                <span class="notice__icon">ℹ️</span>
                <div>
                  <strong>Применен принцип ар-Радд</strong>
                  <p>Остаток имущества был пропорционально распределен между наследниками: ${recipients}.</p>
                </div>
              </div>
            `;
          }

          // Уведомление о распределении остатка между асаба
          if (results.asabaApplied) {
            const asabaRecipients =
              results.asabaRecipients?.join(", ") || "наследники-асаба";
            noticesHtml += `
              <div class="notice notice--info">
                <span class="notice__icon">📜</span>
                <div>
                  <strong>Остаток распределен между асаба</strong>
                  <p>Остаток имущества после фиксированных долей был распределен между: ${asabaRecipients} (соотношение 2:1 для мужчин и женщин).</p>
                </div>
              </div>
            `;
          }

          // Уведомление об аль-Умарийятайн
          if (results.umariyyatanApplied) {
            const caseDescription =
              results.umariyyatanCase === 1
                ? "муж и оба родителя"
                : "жена и оба родителя";
            noticesHtml += `
              <div class="notice notice--info">
                <span class="notice__icon">📚</span>
                <div>
                  <strong>Применен случай аль-Умарийятайн</strong>
                  <p>Особый случай наследования: ${caseDescription}. Мать получает 1/3 от остатка после доли супруга.</p>
                </div>
              </div>
            `;
          }

          this.elements.specialNotices.innerHTML = noticesHtml;
        },

        /**
         * Заполняет таблицу результатов
         * @param {object} results - результаты расчета
         */
        populateResultsTable(results) {
          if (!this.elements.resultsBody) return;

          let tableHtml = "";

          // Показываем только наследников с долей > 0 или незаблокированных
          const displayHeirs = results.heirs.filter(
            (heir) => !heir.blocked || heir.finalFraction.toDecimal() > 0
          );

          displayHeirs.forEach((heir) => {
            const percentage = (heir.percentage || 0).toFixed(2);
            const amount = this.formatAmount(heir.amount || 0);
            const fraction = heir.finalFraction
              ? heir.finalFraction.simplify().toString()
              : "0";

            // Определяем стиль строки для заблокированных наследников
            const rowClass = heir.blocked ? "blocked-heir" : "";
            const blockedText = heir.blocked ? " (заблокирован)" : "";

            tableHtml += `
              <tr class="${rowClass}">
                <td><strong>${heir.name}${blockedText}</strong></td>
                <td>${heir.relation || "—"}</td>
                <td>${fraction}</td>
                <td>${percentage}%</td>
                <td>${amount}</td>
                <td class="dalil-cell">${heir.dalil || "—"}</td>
              </tr>
            `;

            // Если наследник заблокирован, добавляем информацию о блокировке
            if (heir.blocked && heir.blockedBy) {
              tableHtml += `
                <tr class="blocking-info">
                  <td colspan="6">
                    <small class="blocked-hint">↳ ${heir.blockedBy}</small>
                  </td>
                </tr>
              `;
            }
          });

          this.elements.resultsBody.innerHTML = tableHtml;
        },

        /**
         * Заполняет мобильные карточки результатов
         * @param {object} results - результаты расчета
         */
        populateResultsCards(results) {
          if (!this.elements.resultsCards) return;

          let cardsHtml = "";

          // Показываем только наследников с долей > 0 или незаблокированных
          const displayHeirs = results.heirs.filter(
            (heir) => !heir.blocked || heir.finalFraction.toDecimal() > 0
          );

          displayHeirs.forEach((heir) => {
            const percentage = (heir.percentage || 0).toFixed(2);
            const amount = this.formatAmount(heir.amount || 0);
            const fraction = heir.finalFraction
              ? heir.finalFraction.simplify().toString()
              : "0";

            const blockedClass = heir.blocked ? "blocked-heir" : "";
            const blockedText = heir.blocked ? " (заблокирован)" : "";

            cardsHtml += `
              <div class="results-card ${blockedClass}">
                <div class="results-card__header">
                  <span class="results-card__name">${
                    heir.name
                  }${blockedText}</span>
                  <span class="results-card__amount">${amount}</span>
                </div>
                <div class="results-card__details">
                  <div class="results-card__detail">
                    <span class="results-card__label">Отношение:</span>
                    <span>${heir.relation || "—"}</span>
                  </div>
                  <div class="results-card__detail">
                    <span class="results-card__label">Доля:</span>
                    <span>${fraction}</span>
                  </div>
                  <div class="results-card__detail">
                    <span class="results-card__label">Процент:</span>
                    <span>${percentage}%</span>
                  </div>
                </div>
                ${
                  heir.dalil
                    ? `
                  <div class="results-card__dalil">
                    <strong>Обоснование:</strong> ${heir.dalil}
                  </div>
                `
                    : ""
                }
                ${
                  heir.blocked && heir.blockedBy
                    ? `
                  <div class="results-card__blocking">
                    <small class="blocked-hint">${heir.blockedBy}</small>
                  </div>
                `
                    : ""
                }
              </div>
            `;
          });

          // Добавляем итоговую карточку
          const totalPercentage = results.heirs
            .filter((heir) => !heir.blocked)
            .reduce((sum, heir) => sum + (heir.percentage || 0), 0);

          const totalAmount = results.heirs
            .filter((heir) => !heir.blocked)
            .reduce((sum, heir) => sum + (heir.amount || 0), 0);

          const is100Percent = Math.abs(totalPercentage - 100) < 0.01;
          const remainderPercentage = results.remainder?.percentage || 0;
          const remainderAmount = results.remainder?.amount || 0;
          const remainderDestination =
            results.remainder?.destination || AppState.remainderDestination;
          const hasRemainder =
            remainderPercentage > 0.01 || remainderAmount > 0;
          const indicator = hasRemainder ? " ℹ️" : is100Percent ? " ✅" : " ⚠️";
          const totalClass = hasRemainder
            ? "total-warning"
            : is100Percent
            ? "total-valid"
            : "total-warning";
          const remainderSuffix = hasRemainder
            ? ` + остаток ${remainderPercentage.toFixed(2)}%`
            : "";

          cardsHtml += `
            <div class="results-card results-card--total">
              <div class="results-card__header">
                <span class="results-card__name"><strong>Итого</strong></span>
                <span class="results-card__amount"><strong>${this.formatAmount(
                  totalAmount
                )}</strong></span>
              </div>
              <div class="results-card__details">
                <div class="results-card__detail">
                  <span class="results-card__label">Общий процент:</span>
                  <span class="${totalClass}"><strong>${totalPercentage.toFixed(
            2
          )}%${indicator}${remainderSuffix}</strong></span>
                </div>
              </div>
            </div>
          `;

          if (hasRemainder) {
            cardsHtml += `
              <div class="results-card results-card--remainder">
                <div class="results-card__header">
                  <span class="results-card__name"><strong>Остаток</strong></span>
                  <span class="results-card__amount"><strong>${this.formatAmount(
                    remainderAmount
                  )}</strong></span>
                </div>
                <div class="results-card__details">
                  <div class="results-card__detail">
                    <span class="results-card__label">Процент:</span>
                    <span>${remainderPercentage.toFixed(2)}%</span>
                  </div>
                  <div class="results-card__detail">
                    <span class="results-card__label">Направление:</span>
                    <span>Казна/Садакъа</span>
                  </div>
                </div>
              </div>
            `;
          }

          this.elements.resultsCards.innerHTML = cardsHtml;
        },

        /**
         * Показывает блок с информацией об остатке
         * @param {object} results - результаты расчета
         */
        renderRemainder(results) {
          if (!this.elements.remainderPanel) return;

          const remainder = results.remainder || {
            percentage: 0,
            amount: 0,
            destination: AppState.remainderDestination,
          };

          // Учитываем погрешность вычислений с плавающей точкой
          const hasRemainder =
            (remainder.percentage || 0) > 0.01 && (remainder.amount || 0) > 1;

          this.elements.remainderPanel.classList.toggle(
            "hidden",
            !hasRemainder
          );

          if (!hasRemainder) return;

          if (this.elements.remainderPercentage) {
            this.elements.remainderPercentage.textContent = `${remainder.percentage.toFixed(
              2
            )}%`;
          }

          if (this.elements.remainderAmount) {
            this.elements.remainderAmount.textContent = this.formatAmount(
              remainder.amount || 0
            );
          }

          this.syncRemainderDestination(remainder.destination);
        },

        /**
         * Обработчик смены направления остатка
         * @param {string} destination - treasury | charity
         */
        handleRemainderDestinationChange(destination) {
          if (!destination) return;

          AppState.remainderDestination = destination;

          if (AppState.results?.remainder) {
            AppState.results.remainder.destination = destination;
            this.renderRemainder(AppState.results);
            this.updateTotals(AppState.results);
          }
        },

        /**
         * Синхронизирует радиокнопки остатка с состоянием
         * @param {string} destination
         */
        syncRemainderDestination(destination) {
          if (!this.elements.remainderDestinationInputs?.length) return;
          this.elements.remainderDestinationInputs.forEach((input) => {
            input.checked = input.value === destination;
          });
        },

        /**
         * Обновляет итоговые значения
         * @param {object} results - результаты расчета
         */
        updateTotals(results) {
          // Вычисляем общий процент (должен быть 100%)
          const totalPercentage = results.heirs
            .filter((heir) => !heir.blocked)
            .reduce((sum, heir) => sum + (heir.percentage || 0), 0);

          const remainderPercentage = results.remainder?.percentage || 0;
          const hasRemainder = remainderPercentage > 0.01;

          // Вычисляем общую сумму
          const totalAmount = results.heirs
            .filter((heir) => !heir.blocked)
            .reduce((sum, heir) => sum + (heir.amount || 0), 0);

          // Проверяем, равна ли сумма долей 100%
          const is100Percent = Math.abs(totalPercentage - 100) < 0.01;

          // Обновляем отображение процентов с индикатором
          if (this.elements.totalPercentage) {
            const percentageText = `${totalPercentage.toFixed(2)}%`;
            const indicator = hasRemainder
              ? " ℹ️"
              : is100Percent
              ? " ✅"
              : " ⚠️";
            const remainderText = hasRemainder
              ? ` (остаток: ${remainderPercentage.toFixed(2)}%)`
              : "";
            this.elements.totalPercentage.innerHTML = `${percentageText}${indicator}${remainderText}`;

            // Добавляем CSS класс для стилизации
            this.elements.totalPercentage.className = hasRemainder
              ? "total-warning"
              : is100Percent
              ? "total-valid"
              : "total-warning";
          }

          if (this.elements.totalAmount) {
            this.elements.totalAmount.textContent =
              this.formatAmount(totalAmount);
          }
        },

        /**
         * Форматирует денежную сумму
         * @param {number} amount - сумма
         * @returns {string} - отформатированная сумма
         */
        formatAmount(amount) {
          if (amount === 0) return "0";
          return new Intl.NumberFormat("ru-RU", {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
          }).format(amount);
        },

        /**
         * Обработчик печати результатов
         */
        handlePrint() {
          // Добавляем дату в заголовок для печати
          const printDate = new Date().toLocaleDateString("ru-RU", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          const originalTitle = document.title;
          document.title = `${originalTitle} - ${printDate}`;

          // Создаем временный элемент с датой для печати
          this.addPrintDateElement(printDate);

          // Печатаем страницу
          globalThis.print();

          // Восстанавливаем заголовок и удаляем временные элементы
          document.title = originalTitle;
          this.removePrintDateElement();
        },

        /**
         * Добавляет элемент с датой для печатной версии
         * @param {string} printDate - дата печати
         */
        addPrintDateElement(printDate) {
          // Создаем элемент с датой
          const printDateElement = document.createElement("div");
          printDateElement.id = "print-date";
          printDateElement.className = "print-only";
          printDateElement.innerHTML = `
            <div style="text-align: center; margin: 20px 0; font-size: 14px; color: #666;">
              <strong>Дата расчета:</strong> ${printDate}
            </div>
          `;

          // Вставляем перед результатами
          const resultsSection = this.elements.resultsSection;
          if (resultsSection) {
            resultsSection.insertBefore(
              printDateElement,
              resultsSection.firstChild
            );
          }
        },

        /**
         * Удаляет временный элемент с датой
         */
        removePrintDateElement() {
          const printDateElement = document.getElementById("print-date");
          if (printDateElement) {
            printDateElement.remove();
          }
        },

        /**
         * Обработчик нового расчета
         */
        handleRecalculate() {
          // Скрываем результаты
          this.hideResultsSection();

          // Очищаем состояние результатов
          AppState.results = null;
          AppState.appliedRules = {
            awl: false,
            radd: false,
            umariyyatan: false,
          };

          // Очищаем визуальные результаты
          this.clearResults();

          // Прокручиваем к форме
          if (DOM.calculatorMain) {
            DOM.calculatorMain.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
        },

        /**
         * Очищает все результаты
         */
        clearResults() {
          if (this.elements.specialNotices) {
            this.elements.specialNotices.innerHTML = "";
          }
          if (this.elements.resultsBody) {
            this.elements.resultsBody.innerHTML = "";
          }
          if (this.elements.resultsCards) {
            this.elements.resultsCards.innerHTML = "";
          }
          if (this.elements.totalPercentage) {
            this.elements.totalPercentage.textContent = "0%";
          }
          if (this.elements.totalAmount) {
            this.elements.totalAmount.textContent = "0";
          }
          if (this.elements.remainderPanel) {
            this.elements.remainderPanel.classList.add("hidden");
          }
          if (this.elements.remainderAmount) {
            this.elements.remainderAmount.textContent = "0";
          }
          if (this.elements.remainderPercentage) {
            this.elements.remainderPercentage.textContent = "0%";
          }
          this.syncRemainderDestination(AppState.remainderDestination);
        },
      };

      // ========================================
      // Calculation Controller
      // ========================================
      const CalculationController = {
        /**
         * Инициализация контроллера расчетов
         */
        init() {
          this.bindEvents();
        },

        /**
         * Привязка обработчиков событий
         */
        bindEvents() {
          // Обработчик кнопки расчета
          if (DOM.calculateBtn) {
            DOM.calculateBtn.addEventListener("click", () => {
              this.handleCalculate();
            });
          }
        },

        /**
         * Обработчик расчета наследства
         */
        handleCalculate() {
          // Получаем данные формы
          const formData = FormController.getFormData();

          // ОТЛАДКА: Выводим данные формы в консоль
          console.log("=== ОТЛАДКА: Данные формы ===");
          console.log("formData.heirs:", formData.heirs);
          console.log("AppState.heirs:", AppState.heirs);

          // Валидируем данные
          if (!this.validateFormData(formData)) {
            return;
          }

          try {
            // Выполняем расчет (пока заглушка)
            const results = this.calculateInheritance(formData);

            // Отображаем результаты
            ResultsController.displayResults(results);
          } catch (error) {
            console.error("Ошибка при расчете наследства:", error);
            alert(
              "Произошла ошибка при расчете. Пожалуйста, проверьте введенные данные."
            );
          }
        },

        /**
         * Валидирует данные формы перед расчетом
         * @param {object} formData - данные формы
         * @returns {boolean} - результат валидации
         */
        validateFormData(formData) {
          // Проверяем сумму наследства
          if (!formData.estateValid) {
            FormController.showEstateError(formData.estateError);
            DOM.estateAmount?.focus();
            return false;
          }

          // Проверяем наличие хотя бы одного наследника
          if (!FormController.hasAnyHeir()) {
            alert("Пожалуйста, выберите хотя бы одного наследника.");
            return false;
          }

          return true;
        },

        /**
         * Выполняет расчет наследства (временная заглушка)
         * @param {object} formData - данные формы
         * @returns {object} - результаты расчета
         */
        calculateInheritance(formData) {
          const results = {
            heirs: [],
            totalDistributed: 100,
            awlApplied: false,
            awlRatio: null,
            raddApplied: false,
            raddRecipients: [],
            umariyyatanApplied: false,
            umariyyatanCase: null,
            remainder: {
              percentage: 0,
              amount: 0,
              destination: AppState.remainderDestination || "treasury",
            },
          };

          // Определяем наличие блокирующих наследников
          const hasDescendants =
            formData.heirs.sons > 0 ||
            formData.heirs.daughters > 0 ||
            formData.heirs.grandsonsFromSon > 0 ||
            formData.heirs.granddaughtersFromSon > 0;

          const hasFather =
            formData.heirs.father || formData.heirs.paternalGrandfather;
          const hasMother = formData.heirs.mother;

          const hasFullSiblings =
            formData.heirs.fullBrothers > 0 || formData.heirs.fullSisters > 0;
          const hasPaternalSiblings =
            formData.heirs.paternalBrothers > 0 ||
            formData.heirs.paternalSisters > 0;
          const hasDistantAsabaCandidates =
            formData.heirs.nephewsFullBrothers > 0 ||
            formData.heirs.nephewsPaternalBrothers > 0 ||
            formData.heirs.unclesFull > 0 ||
            formData.heirs.unclesPaternal > 0;
          const hasCloserAgnaticHeirs =
            formData.heirs.sons > 0 ||
            formData.heirs.grandsonsFromSon > 0 ||
            formData.heirs.father ||
            formData.heirs.paternalGrandfather ||
            hasFullSiblings ||
            hasPaternalSiblings;

          // Массив для фиксированных долей (Fara'id) - будет использован в полной реализации
          // let fixedShares = new Fraction(0, 1);

          // 1. СУПРУГИ (Zawj/Zawja)
          if (formData.heirs.husband) {
            const husbandFraction = hasDescendants
              ? new Fraction(1, 4)
              : new Fraction(1, 2);
            results.heirs.push({
              name: "Муж",
              relation: "Супруг покойной",
              baseFraction: husbandFraction,
              finalFraction: husbandFraction,
              percentage: husbandFraction.toDecimal() * 100,
              amount: formData.totalEstate * husbandFraction.toDecimal(),
              dalil: 'Коран, сура "ан-Ниса", 4:12',
              blocked: false,
              blockedBy: null,
            });
          }

          if (formData.heirs.wife) {
            const wifeFraction = hasDescendants
              ? new Fraction(1, 8)
              : new Fraction(1, 4);
            results.heirs.push({
              name:
                formData.heirs.wifeCount > 1
                  ? `Жены (${formData.heirs.wifeCount})`
                  : "Жена",
              relation: "Супруга покойного",
              baseFraction: wifeFraction,
              finalFraction: wifeFraction,
              percentage: wifeFraction.toDecimal() * 100,
              amount: formData.totalEstate * wifeFraction.toDecimal(),
              dalil: 'Коран, сура "ан-Ниса", 4:12',
              blocked: false,
              blockedBy: null,
            });
          }

          // 2. ПРЕДКИ (Usul)
          if (formData.heirs.father) {
            const fatherFraction = new Fraction(1, 6);
            results.heirs.push({
              name: "Отец",
              relation: "Предок покойного",
              baseFraction: fatherFraction,
              finalFraction: fatherFraction,
              percentage: fatherFraction.toDecimal() * 100,
              amount: formData.totalEstate * fatherFraction.toDecimal(),
              dalil: 'Коран, сура "ан-Ниса", 4:11',
              blocked: false,
              blockedBy: null,
            });
          }

          if (formData.heirs.paternalGrandfather) {
            if (formData.heirs.father) {
              results.heirs.push({
                name: "Дед (отец отца)",
                relation: "Предок покойного",
                baseFraction: new Fraction(0, 1),
                finalFraction: new Fraction(0, 1),
                percentage: 0,
                amount: 0,
                dalil: 'Коран, сура "ан-Ниса", 4:11',
                blocked: true,
                blockedBy: "Блокируется отцом",
              });
            } else {
              const grandfatherFraction = new Fraction(1, 6);
              results.heirs.push({
                name: "Дед (отец отца)",
                relation: "Предок покойного",
                baseFraction: grandfatherFraction,
                finalFraction: grandfatherFraction,
                percentage: grandfatherFraction.toDecimal() * 100,
                amount: formData.totalEstate * grandfatherFraction.toDecimal(),
                dalil: 'Коран, сура "ан-Ниса", 4:11',
                blocked: false,
                blockedBy: null,
              });
            }
          }

          if (formData.heirs.mother) {
            const motherFraction =
              !hasDescendants && !hasFullSiblings && !hasPaternalSiblings
                ? new Fraction(1, 3)
                : new Fraction(1, 6);

            results.heirs.push({
              name: "Мать",
              relation: "Предок покойного",
              baseFraction: motherFraction,
              finalFraction: motherFraction,
              percentage: motherFraction.toDecimal() * 100,
              amount: formData.totalEstate * motherFraction.toDecimal(),
              dalil: 'Коран, сура "ан-Ниса", 4:11',
              blocked: false,
              blockedBy: null,
            });
          }

          // Бабушки получают 1/6 если нет матери (делят поровну если обе)
          if (
            !hasMother &&
            (formData.heirs.paternalGrandmother ||
              formData.heirs.maternalGrandmother)
          ) {
            const grandmothersCount =
              (formData.heirs.paternalGrandmother ? 1 : 0) +
              (formData.heirs.maternalGrandmother ? 1 : 0);
            const grandmotherFraction = new Fraction(1, 6 * grandmothersCount);

            if (formData.heirs.paternalGrandmother) {
              results.heirs.push({
                name: "Бабушка (мать отца)",
                relation: "Предок покойного",
                baseFraction: grandmotherFraction,
                finalFraction: grandmotherFraction,
                percentage: grandmotherFraction.toDecimal() * 100,
                amount: formData.totalEstate * grandmotherFraction.toDecimal(),
                dalil: 'Коран, сура "ан-Ниса", 4:11',
                blocked: false,
                blockedBy: null,
              });
            }

            if (formData.heirs.maternalGrandmother) {
              results.heirs.push({
                name: "Бабушка (мать матери)",
                relation: "Предок покойного",
                baseFraction: grandmotherFraction,
                finalFraction: grandmotherFraction,
                percentage: grandmotherFraction.toDecimal() * 100,
                amount: formData.totalEstate * grandmotherFraction.toDecimal(),
                dalil: 'Коран, сура "ан-Ниса", 4:11',
                blocked: false,
                blockedBy: null,
              });
            }
          } else if (hasMother) {
            // Бабушки блокируются матерью
            if (formData.heirs.paternalGrandmother) {
              results.heirs.push({
                name: "Бабушка (мать отца)",
                relation: "Предок покойного",
                baseFraction: new Fraction(0, 1),
                finalFraction: new Fraction(0, 1),
                percentage: 0,
                amount: 0,
                dalil: 'Коран, сура "ан-Ниса", 4:11',
                blocked: true,
                blockedBy: "Блокируется матерью",
              });
            }
            if (formData.heirs.maternalGrandmother) {
              results.heirs.push({
                name: "Бабушка (мать матери)",
                relation: "Предок покойного",
                baseFraction: new Fraction(0, 1),
                finalFraction: new Fraction(0, 1),
                percentage: 0,
                amount: 0,
                dalil: 'Коран, сура "ан-Ниса", 4:11',
                blocked: true,
                blockedBy: "Блокируется матерью",
              });
            }
          }

          // 3. ПОТОМКИ (Furu')
          if (formData.heirs.sons > 0) {
            // Сыновья и дочери делят остаток как асааба (2:1)
            const remainder = calculateRemainder(formData.heirs);
            const totalUnits =
              formData.heirs.sons * 2 + formData.heirs.daughters;
            const unitFraction =
              totalUnits > 0
                ? remainder.divide(new Fraction(totalUnits, 1))
                : new Fraction(0, 1);

            // Доля одного сына (2 единицы)
            const perSonFraction = unitFraction.multiply(new Fraction(2, 1));
            // Общая доля всех сыновей
            const totalSonsFraction = perSonFraction.multiply(
              new Fraction(formData.heirs.sons, 1)
            );
            results.heirs.push({
              name:
                formData.heirs.sons === 1
                  ? "Сын"
                  : `Сыновья (${formData.heirs.sons})`,
              relation: "Потомок покойного",
              baseFraction: totalSonsFraction,
              finalFraction: totalSonsFraction,
              percentage: totalSonsFraction.toDecimal() * 100,
              amount: formData.totalEstate * totalSonsFraction.toDecimal(),
              dalil: 'Коран, сура "ан-Ниса", 4:11',
              blocked: false,
              blockedBy: null,
            });

            if (formData.heirs.daughters > 0) {
              // Доля одной дочери (1 единица)
              const perDaughterFraction = unitFraction;
              // Общая доля всех дочерей
              const totalDaughtersFraction = perDaughterFraction.multiply(
                new Fraction(formData.heirs.daughters, 1)
              );
              results.heirs.push({
                name:
                  formData.heirs.daughters === 1
                    ? "Дочь"
                    : `Дочери (${formData.heirs.daughters})`,
                relation: "Потомок покойного",
                baseFraction: totalDaughtersFraction,
                finalFraction: totalDaughtersFraction,
                percentage: totalDaughtersFraction.toDecimal() * 100,
                amount:
                  formData.totalEstate * totalDaughtersFraction.toDecimal(),
                dalil: 'Коран, сура "ан-Ниса", 4:11',
                blocked: false,
                blockedBy: null,
              });
            }
          } else if (formData.heirs.daughters > 0) {
            const daughterFraction =
              formData.heirs.daughters === 1
                ? new Fraction(1, 2)
                : new Fraction(2, 3);

            results.heirs.push({
              name:
                formData.heirs.daughters === 1
                  ? "Дочь"
                  : `Дочери (${formData.heirs.daughters})`,
              relation: "Потомок покойного",
              baseFraction: daughterFraction,
              finalFraction: daughterFraction,
              percentage: daughterFraction.toDecimal() * 100,
              amount: formData.totalEstate * daughterFraction.toDecimal(),
              dalil: 'Коран, сура "ан-Ниса", 4:11',
              blocked: false,
              blockedBy: null,
            });
          }

          if (
            formData.heirs.grandsonsFromSon > 0 &&
            formData.heirs.sons === 0
          ) {
            const grandsonShare = 1 / 4; // Примерная доля
            results.heirs.push({
              name:
                formData.heirs.grandsonsFromSon === 1
                  ? "Внук от сына"
                  : `Внуки от сына (${formData.heirs.grandsonsFromSon})`,
              relation: "Потомок покойного",
              baseFraction: new Fraction(1, 4),
              finalFraction: new Fraction(1, 4),
              percentage: grandsonShare * 100,
              amount: formData.totalEstate * grandsonShare,
              dalil: 'Коран, сура "ан-Ниса", 4:11',
              blocked: false,
              blockedBy: null,
            });
          } else if (
            formData.heirs.grandsonsFromSon > 0 &&
            formData.heirs.sons > 0
          ) {
            results.heirs.push({
              name:
                formData.heirs.grandsonsFromSon === 1
                  ? "Внук от сына"
                  : `Внуки от сына (${formData.heirs.grandsonsFromSon})`,
              relation: "Потомок покойного",
              baseFraction: new Fraction(0, 1),
              finalFraction: new Fraction(0, 1),
              percentage: 0,
              amount: 0,
              dalil: 'Коран, сура "ан-Ниса", 4:11',
              blocked: true,
              blockedBy: "Блокируются сыновьями",
            });
          }

          if (
            formData.heirs.granddaughtersFromSon > 0 &&
            formData.heirs.sons === 0
          ) {
            const granddaughterShare =
              formData.heirs.daughters === 0
                ? formData.heirs.granddaughtersFromSon === 1
                  ? 1 / 2
                  : 2 / 3
                : 1 / 6;
            let granddaughterFraction;
            if (formData.heirs.daughters === 0) {
              granddaughterFraction =
                formData.heirs.granddaughtersFromSon === 1
                  ? new Fraction(1, 2)
                  : new Fraction(2, 3);
            } else {
              granddaughterFraction = new Fraction(1, 6);
            }

            results.heirs.push({
              name:
                formData.heirs.granddaughtersFromSon === 1
                  ? "Внучка от сына"
                  : `Внучки от сына (${formData.heirs.granddaughtersFromSon})`,
              relation: "Потомок покойного",
              baseFraction: granddaughterFraction,
              finalFraction: granddaughterFraction,
              percentage: granddaughterShare * 100,
              amount: formData.totalEstate * granddaughterShare,
              dalil: 'Коран, сура "ан-Ниса", 4:11',
              blocked: false,
              blockedBy: null,
            });
          } else if (
            formData.heirs.granddaughtersFromSon > 0 &&
            formData.heirs.sons > 0
          ) {
            results.heirs.push({
              name:
                formData.heirs.granddaughtersFromSon === 1
                  ? "Внучка от сына"
                  : `Внучки от сына (${formData.heirs.granddaughtersFromSon})`,
              relation: "Потомок покойного",
              baseFraction: new Fraction(0, 1),
              finalFraction: new Fraction(0, 1),
              percentage: 0,
              amount: 0,
              dalil: 'Коран, сура "ан-Ниса", 4:11',
              blocked: true,
              blockedBy: "Блокируются сыновьями",
            });
          }

          // БРАТЬЯ И СЕСТРЫ
          // Братья блокируются ТОЛЬКО сыновьями, внуками от сына, отцом или дедом
          // Дочери и внучки НЕ блокируют братьев — братья становятся асаба
          const brothersBlockedBy =
            formData.heirs.sons > 0 || formData.heirs.grandsonsFromSon > 0;

          // Для сестер без братьев — они блокируются также потомками-женщинами
          // (когда становятся асаба ма'а гайрихи с дочерьми)
          const hasDescendantsForSiblings =
            formData.heirs.sons > 0 ||
            formData.heirs.daughters > 0 ||
            formData.heirs.grandsonsFromSon > 0 ||
            formData.heirs.granddaughtersFromSon > 0;

          // Проверяем, блокируется ли брат дедом (по мнению Абу Бакра)
          const brothersBlockedByGrandfather =
            formData.heirs.paternalGrandfather;

          // Полнородные братья и сестры
          if (
            formData.heirs.fullBrothers > 0 &&
            !brothersBlockedBy &&
            !hasFather &&
            !brothersBlockedByGrandfather
          ) {
            // Братья становятся асаба и делят остаток вместе с сестрами (2:1)
            const remainder = calculateRemainder(formData.heirs);
            const brotherCount = formData.heirs.fullBrothers;
            const sisterCount = formData.heirs.fullSisters;
            const totalUnits = brotherCount * 2 + sisterCount;
            const unitFraction =
              totalUnits > 0
                ? remainder.divide(new Fraction(totalUnits, 1))
                : new Fraction(0, 1);

            const brotherFraction = unitFraction.multiply(new Fraction(2, 1));
            const brotherTotalFraction = brotherFraction.multiply(
              new Fraction(brotherCount, 1)
            );

            results.heirs.push({
              name:
                brotherCount === 1
                  ? "Брат (полнородный)"
                  : `Братья полнородные (${brotherCount})`,
              relation: "Брат покойного",
              baseFraction: brotherTotalFraction,
              finalFraction: brotherTotalFraction,
              percentage: brotherTotalFraction.toDecimal() * 100,
              amount: formData.totalEstate * brotherTotalFraction.toDecimal(),
              dalil: 'Коран, сура "ан-Ниса", 4:176',
              blocked: false,
              blockedBy: null,
            });

            if (sisterCount > 0) {
              const sisterAsabaFraction = unitFraction.multiply(
                new Fraction(sisterCount, 1)
              );
              results.heirs.push({
                name:
                  sisterCount === 1
                    ? "Сестра (полнородная)"
                    : `Сестры полнородные (${sisterCount})`,
                relation: "Сестра покойного",
                baseFraction: sisterAsabaFraction,
                finalFraction: sisterAsabaFraction,
                percentage: sisterAsabaFraction.toDecimal() * 100,
                amount: formData.totalEstate * sisterAsabaFraction.toDecimal(),
                dalil: 'Коран, сура "ан-Ниса", 4:176',
                blocked: false,
                blockedBy: null,
              });
            }

            // Помечаем что остаток распределён между асаба
            results.asabaApplied = true;
            results.asabaRecipients = results.asabaRecipients || [];
            results.asabaRecipients.push(
              brotherCount === 1
                ? "Брат (полнородный)"
                : `Братья полнородные (${brotherCount})`
            );
            if (sisterCount > 0) {
              results.asabaRecipients.push(
                sisterCount === 1
                  ? "Сестра (полнородная)"
                  : `Сёстры полнородные (${sisterCount})`
              );
            }
          } else if (
            formData.heirs.fullBrothers > 0 &&
            (brothersBlockedBy || hasFather || brothersBlockedByGrandfather)
          ) {
            // Братья заблокированы
            let blockedByReason = "Блокируются";
            if (formData.heirs.sons > 0) {
              blockedByReason = "Блокируются сыновьями";
            } else if (formData.heirs.grandsonsFromSon > 0) {
              blockedByReason = "Блокируются внуками от сына";
            } else if (hasFather) {
              blockedByReason = "Блокируются отцом";
            } else if (brothersBlockedByGrandfather) {
              blockedByReason = "Блокируются дедом (отцом отца)";
            }

            results.heirs.push({
              name:
                formData.heirs.fullBrothers === 1
                  ? "Брат (полнородный)"
                  : `Братья полнородные (${formData.heirs.fullBrothers})`,
              relation: "Брат покойного",
              baseFraction: new Fraction(0, 1),
              finalFraction: new Fraction(0, 1),
              percentage: 0,
              amount: 0,
              dalil: 'Коран, сура "ан-Ниса", 4:176',
              blocked: true,
              blockedBy: blockedByReason,
            });
          }

          if (
            formData.heirs.fullSisters > 0 &&
            !hasDescendantsForSiblings &&
            !hasFather &&
            formData.heirs.fullBrothers === 0
          ) {
            // Рассчитываем остаток после фиксированных долей
            let fixedShares = 0;

            // Жена: 1/4
            if (formData.heirs.wife) {
              fixedShares +=
                formData.heirs.sons > 0 || formData.heirs.daughters > 0
                  ? 1 / 8
                  : 1 / 4;
            }

            // Бабушки: 1/6 общая доля
            if (
              (formData.heirs.paternalGrandmother ||
                formData.heirs.maternalGrandmother) &&
              !formData.heirs.mother
            ) {
              fixedShares += 1 / 6;
            }

            // Остаток для сестер
            const remainingShare = 1 - fixedShares;
            const fullSisterShare = remainingShare;
            const fullSisterFraction =
              Fraction.fromDecimal(remainingShare).simplify();

            results.heirs.push({
              name:
                formData.heirs.fullSisters === 1
                  ? "Сестра (полнородная)"
                  : `Сестры полнородные (${formData.heirs.fullSisters})`,
              relation: "Сестра покойного",
              baseFraction: fullSisterFraction,
              finalFraction: fullSisterFraction,
              percentage: fullSisterShare * 100,
              amount: formData.totalEstate * fullSisterShare,
              dalil: 'Коран, сура "ан-Ниса", 4:176',
              blocked: false,
              blockedBy: null,
            });
          } else if (
            formData.heirs.fullSisters > 0 &&
            (hasDescendantsForSiblings || hasFather)
          ) {
            // Сёстры заблокированы сыновьями/внуками или отцом
            let sistersBlockedByReason = "Блокируются";
            if (formData.heirs.sons > 0) {
              sistersBlockedByReason = "Блокируются сыновьями";
            } else if (formData.heirs.grandsonsFromSon > 0) {
              sistersBlockedByReason = "Блокируются внуками от сына";
            } else if (hasFather) {
              sistersBlockedByReason = "Блокируются отцом";
            }

            results.heirs.push({
              name:
                formData.heirs.fullSisters === 1
                  ? "Сестра (полнородная)"
                  : `Сестры полнородные (${formData.heirs.fullSisters})`,
              relation: "Сестра покойного",
              baseFraction: new Fraction(0, 1),
              finalFraction: new Fraction(0, 1),
              percentage: 0,
              amount: 0,
              dalil: 'Коран, сура "ан-Ниса", 4:176',
              blocked: true,
              blockedBy: sistersBlockedByReason,
            });
          }

          // Единокровные братья и сестры (по отцу)

          if (
            formData.heirs.paternalBrothers > 0 &&
            !hasDescendantsForSiblings &&
            !hasFather &&
            !hasFullSiblings
          ) {
            const paternalBrotherShare = 1 / 5; // Примерная доля
            results.heirs.push({
              name:
                formData.heirs.paternalBrothers === 1
                  ? "Брат (единокровный)"
                  : `Братья единокровные (${formData.heirs.paternalBrothers})`,
              relation: "Брат покойного",
              baseFraction: new Fraction(1, 5),
              finalFraction: new Fraction(1, 5),
              percentage: paternalBrotherShare * 100,
              amount: formData.totalEstate * paternalBrotherShare,
              dalil: 'Коран, сура "ан-Ниса", 4:176',
              blocked: false,
              blockedBy: null,
            });
          } else if (formData.heirs.paternalBrothers > 0) {
            let blockReason = "";
            if (hasDescendantsForSiblings)
              blockReason = "Блокируются потомками";
            else if (hasFather) blockReason = "Блокируются отцом";
            else if (hasFullSiblings)
              blockReason = "Блокируются полнородными братьями/сестрами";

            results.heirs.push({
              name:
                formData.heirs.paternalBrothers === 1
                  ? "Брат (единокровный)"
                  : `Братья единокровные (${formData.heirs.paternalBrothers})`,
              relation: "Брат покойного",
              baseFraction: new Fraction(0, 1),
              finalFraction: new Fraction(0, 1),
              percentage: 0,
              amount: 0,
              dalil: 'Коран, сура "ан-Ниса", 4:176',
              blocked: true,
              blockedBy: blockReason,
            });
          }

          if (
            formData.heirs.paternalSisters > 0 &&
            !hasDescendantsForSiblings &&
            !hasFather &&
            !hasFullSiblings
          ) {
            const paternalSisterShare =
              formData.heirs.paternalBrothers > 0
                ? 1 / 10
                : formData.heirs.paternalSisters === 1
                ? 1 / 2
                : 2 / 3;
            let paternalSisterFraction;
            if (formData.heirs.paternalBrothers > 0) {
              paternalSisterFraction = new Fraction(1, 10);
            } else if (formData.heirs.paternalSisters === 1) {
              paternalSisterFraction = new Fraction(1, 2);
            } else {
              paternalSisterFraction = new Fraction(2, 3);
            }

            results.heirs.push({
              name:
                formData.heirs.paternalSisters === 1
                  ? "Сестра (единокровная)"
                  : `Сестры единокровные (${formData.heirs.paternalSisters})`,
              relation: "Сестра покойного",
              baseFraction: paternalSisterFraction,
              finalFraction: paternalSisterFraction,
              percentage: paternalSisterShare * 100,
              amount: formData.totalEstate * paternalSisterShare,
              dalil: 'Коран, сура "ан-Ниса", 4:176',
              blocked: false,
              blockedBy: null,
            });
          } else if (formData.heirs.paternalSisters > 0) {
            let blockReason = "";
            if (hasDescendantsForSiblings)
              blockReason = "Блокируются потомками";
            else if (hasFather) blockReason = "Блокируются отцом";
            else if (hasFullSiblings)
              blockReason = "Блокируются полнородными братьями/сестрами";

            results.heirs.push({
              name:
                formData.heirs.paternalSisters === 1
                  ? "Сестра (единокровная)"
                  : `Сестры единокровные (${formData.heirs.paternalSisters})`,
              relation: "Сестра покойного",
              baseFraction: new Fraction(0, 1),
              finalFraction: new Fraction(0, 1),
              percentage: 0,
              amount: 0,
              dalil: 'Коран, сура "ан-Ниса", 4:176',
              blocked: true,
              blockedBy: blockReason,
            });
          }

          // Единоутробные братья и сестры (по матери)
          const totalMaternalSiblings =
            formData.heirs.maternalBrothers + formData.heirs.maternalSisters;
          if (
            totalMaternalSiblings > 0 &&
            !hasDescendantsForSiblings &&
            !hasFather
          ) {
            const maternalSiblingShare =
              totalMaternalSiblings === 1 ? 1 / 6 : 1 / 3;
            const maternalSiblingFraction =
              totalMaternalSiblings === 1
                ? new Fraction(1, 6)
                : new Fraction(1, 3);

            if (formData.heirs.maternalBrothers > 0) {
              const individualShare =
                maternalSiblingShare / totalMaternalSiblings;
              const individualFraction = new Fraction(
                maternalSiblingFraction.num,
                maternalSiblingFraction.den * totalMaternalSiblings
              ).simplify();

              results.heirs.push({
                name:
                  formData.heirs.maternalBrothers === 1
                    ? "Брат (единоутробный)"
                    : `Братья единоутробные (${formData.heirs.maternalBrothers})`,
                relation: "Брат покойного",
                baseFraction: individualFraction,
                finalFraction: individualFraction,
                percentage:
                  individualShare * formData.heirs.maternalBrothers * 100,
                amount:
                  formData.totalEstate *
                  individualShare *
                  formData.heirs.maternalBrothers,
                dalil: 'Коран, сура "ан-Ниса", 4:12',
                blocked: false,
                blockedBy: null,
              });
            }

            if (formData.heirs.maternalSisters > 0) {
              const individualShare =
                maternalSiblingShare / totalMaternalSiblings;
              const individualFraction = new Fraction(
                maternalSiblingFraction.num,
                maternalSiblingFraction.den * totalMaternalSiblings
              ).simplify();

              results.heirs.push({
                name:
                  formData.heirs.maternalSisters === 1
                    ? "Сестра (единоутробная)"
                    : `Сестры единоутробные (${formData.heirs.maternalSisters})`,
                relation: "Сестра покойного",
                baseFraction: individualFraction,
                finalFraction: individualFraction,
                percentage:
                  individualShare * formData.heirs.maternalSisters * 100,
                amount:
                  formData.totalEstate *
                  individualShare *
                  formData.heirs.maternalSisters,
                dalil: 'Коран, сура "ан-Ниса", 4:12',
                blocked: false,
                blockedBy: null,
              });
            }
          } else if (totalMaternalSiblings > 0) {
            if (formData.heirs.maternalBrothers > 0) {
              results.heirs.push({
                name:
                  formData.heirs.maternalBrothers === 1
                    ? "Брат (единоутробный)"
                    : `Братья единоутробные (${formData.heirs.maternalBrothers})`,
                relation: "Брат покойного",
                baseFraction: new Fraction(0, 1),
                finalFraction: new Fraction(0, 1),
                percentage: 0,
                amount: 0,
                dalil: 'Коран, сура "ан-Ниса", 4:12',
                blocked: true,
                blockedBy: hasDescendantsForSiblings
                  ? "Блокируются потомками"
                  : "Блокируются отцом",
              });
            }

            if (formData.heirs.maternalSisters > 0) {
              results.heirs.push({
                name:
                  formData.heirs.maternalSisters === 1
                    ? "Сестра (единоутробная)"
                    : `Сестры единоутробные (${formData.heirs.maternalSisters})`,
                relation: "Сестра покойного",
                baseFraction: new Fraction(0, 1),
                finalFraction: new Fraction(0, 1),
                percentage: 0,
                amount: 0,
                dalil: 'Коран, сура "ан-Ниса", 4:12',
                blocked: true,
                blockedBy: hasDescendantsForSiblings
                  ? "Блокируются потомками"
                  : "Блокируются отцом",
              });
            }
          }

          // ДАЛЬНИЕ АСААБА (племянники и дяди)
          // Сначала определим, кто из дальних асааба получит остаток (если нет близких)
          // Логика: дальние асааба наследуют только если нет более близких агнатов
          // Приоритет: племянники от полнородных > племянники от единокровных > дяди родные > дяди единокровные

          const distantAsabaBlockReason = hasCloserAgnaticHeirs
            ? "Блокируются более близкими наследниками (сын/внук/отец/дед/братья)"
            : null;

          // Флаги для отслеживания, кто из дальних асааба уже получил остаток
          let distantAsabaAllocated = false;

          // Подсчитываем итоговый процент и остаток
          let totalPercentage = results.heirs.reduce(
            (sum, heir) => sum + heir.percentage,
            0
          );

          // Если сумма долей превышает 100%, применяем аль-Авль (пропорционально уменьшаем)
          if (totalPercentage > 100.0001) {
            const awlRatioValue = 100 / totalPercentage;
            const awlRatioFraction = Fraction.fromDecimal(awlRatioValue);

            results.awlApplied = true;
            results.awlRatio = awlRatioFraction;

            results.heirs = results.heirs.map((heir) => {
              const scaled = { ...heir };
              const originalPercentage = heir.percentage || 0;

              // Масштабируем процент и дробь наследника
              scaled.percentage = originalPercentage * awlRatioValue;
              if (heir.finalFraction && heir.finalFraction.multiply) {
                scaled.finalFraction = heir.finalFraction
                  .multiply(awlRatioFraction)
                  .simplify();
              }

              // Пересчитываем сумму в валюте
              scaled.amount = formData.totalEstate * (scaled.percentage / 100);

              return scaled;
            });

            // Пересчитываем суммарный процент после применения аль-Авль
            totalPercentage = results.heirs
              .filter((heir) => !heir.blocked)
              .reduce((sum, heir) => sum + (heir.percentage || 0), 0);
          }

          let remainderPct = Math.max(0, 100 - totalPercentage);
          let remainderAmount = formData.totalEstate * (remainderPct / 100);

          // Если есть отец и остаток, он забирает остаток как асаба
          if (remainderPct > 0.0001 && formData.heirs.father) {
            const fatherHeir = results.heirs.find((h) => h.name === "Отец");
            if (fatherHeir) {
              const remainderFraction = Fraction.fromDecimal(
                remainderPct / 100
              );
              fatherHeir.finalFraction = fatherHeir.finalFraction
                .add(remainderFraction)
                .simplify();
              fatherHeir.baseFraction = fatherHeir.finalFraction.clone();
              fatherHeir.percentage += remainderPct;
              fatherHeir.amount += remainderAmount;

              // После передачи остатка отцу доли закрываются
              totalPercentage = 100;
              remainderPct = 0;
              remainderAmount = 0;
            }
          }

          // Остаток передается дальним асаба по приоритету, если нет ближних
          // Теперь добавляем дальних асааба в результаты (с долей или как заблокированных)
          if (
            remainderPct > 0.0001 &&
            !formData.heirs.father &&
            !hasCloserAgnaticHeirs &&
            hasDistantAsabaCandidates
          ) {
            const remainderFraction = Fraction.fromDecimal(remainderPct / 100);

            // Функция для создания записи наследника с долей
            const createHeirWithShare = (count, name) => {
              const sharePerHeir = remainderFraction.divide(
                new Fraction(count, 1)
              );
              return {
                name: name,
                relation: "Асааба по линии отца",
                baseFraction: sharePerHeir.multiply(new Fraction(count, 1)),
                finalFraction: sharePerHeir.multiply(new Fraction(count, 1)),
                percentage: remainderPct,
                amount: remainderAmount,
                dalil:
                  "Порядок асаба по мужской линии: сын → внук → отец → дед → братья → племянники → дяди",
                blocked: false,
                blockedBy: null,
              };
            };

            let allocated = false;

            // 1) Сыны полнородных братьев - получают остаток
            if (formData.heirs.nephewsFullBrothers > 0) {
              const name =
                formData.heirs.nephewsFullBrothers === 1
                  ? "Племянник (сын полнородного брата)"
                  : `Племянники - сыны полнородных братьев (${formData.heirs.nephewsFullBrothers})`;
              results.heirs.push(
                createHeirWithShare(formData.heirs.nephewsFullBrothers, name)
              );
              allocated = true;
              distantAsabaAllocated = true;
            }

            // 2) Сыны единокровных братьев
            if (formData.heirs.nephewsPaternalBrothers > 0) {
              const name =
                formData.heirs.nephewsPaternalBrothers === 1
                  ? "Племянник (сын единокровного брата)"
                  : `Племянники - сыны единокровных братьев (${formData.heirs.nephewsPaternalBrothers})`;
              if (!allocated) {
                results.heirs.push(
                  createHeirWithShare(
                    formData.heirs.nephewsPaternalBrothers,
                    name
                  )
                );
                allocated = true;
                distantAsabaAllocated = true;
              } else {
                // Добавляем как заблокированных
                results.heirs.push({
                  name: name,
                  relation: "Асааба по линии отца",
                  baseFraction: new Fraction(0, 1),
                  finalFraction: new Fraction(0, 1),
                  percentage: 0,
                  amount: 0,
                  dalil:
                    "Порядок асаба по мужской линии: сын → внук → отец → дед → братья → племянники → дяди",
                  blocked: true,
                  blockedBy: "Блокируются племянниками от полнородных братьев",
                });
              }
            }

            // 3) Родные дяди (братья отца)
            if (formData.heirs.unclesFull > 0) {
              const name =
                formData.heirs.unclesFull === 1
                  ? "Дядя (родной брат отца)"
                  : `Дяди - родные братья отца (${formData.heirs.unclesFull})`;
              if (!allocated) {
                results.heirs.push(
                  createHeirWithShare(formData.heirs.unclesFull, name)
                );
                allocated = true;
                distantAsabaAllocated = true;
              } else {
                results.heirs.push({
                  name: name,
                  relation: "Асааба по линии отца",
                  baseFraction: new Fraction(0, 1),
                  finalFraction: new Fraction(0, 1),
                  percentage: 0,
                  amount: 0,
                  dalil:
                    "Порядок асаба по мужской линии: сын → внук → отец → дед → братья → племянники → дяди",
                  blocked: true,
                  blockedBy: "Блокируются племянниками",
                });
              }
            }

            // 4) Единокровные дяди
            if (formData.heirs.unclesPaternal > 0) {
              const name =
                formData.heirs.unclesPaternal === 1
                  ? "Дядя (единокровный брат отца)"
                  : `Дяди - единокровные братья отца (${formData.heirs.unclesPaternal})`;
              if (!allocated) {
                results.heirs.push(
                  createHeirWithShare(formData.heirs.unclesPaternal, name)
                );
                allocated = true;
                distantAsabaAllocated = true;
              } else {
                const blockReason =
                  formData.heirs.unclesFull > 0
                    ? "Блокируются родными дядями"
                    : "Блокируются племянниками";
                results.heirs.push({
                  name: name,
                  relation: "Асааба по линии отца",
                  baseFraction: new Fraction(0, 1),
                  finalFraction: new Fraction(0, 1),
                  percentage: 0,
                  amount: 0,
                  dalil:
                    "Порядок асаба по мужской линии: сын → внук → отец → дед → братья → племянники → дяди",
                  blocked: true,
                  blockedBy: blockReason,
                });
              }
            }

            if (allocated) {
              totalPercentage = 100;
              remainderPct = 0;
              remainderAmount = 0;
            }
          } else if (hasDistantAsabaCandidates) {
            // Если есть близкие агнаты, добавляем дальних асааба как заблокированных
            if (formData.heirs.nephewsFullBrothers > 0) {
              results.heirs.push({
                name:
                  formData.heirs.nephewsFullBrothers === 1
                    ? "Племянник (сын полнородного брата)"
                    : `Племянники - сыны полнородных братьев (${formData.heirs.nephewsFullBrothers})`,
                relation: "Асааба по линии отца",
                baseFraction: new Fraction(0, 1),
                finalFraction: new Fraction(0, 1),
                percentage: 0,
                amount: 0,
                dalil:
                  "Порядок асаба по мужской линии: сын → внук → отец → дед → братья → племянники → дяди",
                blocked: true,
                blockedBy: distantAsabaBlockReason,
              });
            }

            if (formData.heirs.nephewsPaternalBrothers > 0) {
              const blockReason = hasCloserAgnaticHeirs
                ? distantAsabaBlockReason
                : formData.heirs.nephewsFullBrothers > 0
                ? "Блокируются племянниками от полнородных братьев"
                : distantAsabaBlockReason;
              results.heirs.push({
                name:
                  formData.heirs.nephewsPaternalBrothers === 1
                    ? "Племянник (сын единокровного брата)"
                    : `Племянники - сыны единокровных братьев (${formData.heirs.nephewsPaternalBrothers})`,
                relation: "Асааба по линии отца",
                baseFraction: new Fraction(0, 1),
                finalFraction: new Fraction(0, 1),
                percentage: 0,
                amount: 0,
                dalil:
                  "Порядок асаба по мужской линии: сын → внук → отец → дед → братья → племянники → дяди",
                blocked: true,
                blockedBy: blockReason,
              });
            }

            if (formData.heirs.unclesFull > 0) {
              const blockReason = hasCloserAgnaticHeirs
                ? distantAsabaBlockReason
                : "Блокируются племянниками";
              results.heirs.push({
                name:
                  formData.heirs.unclesFull === 1
                    ? "Дядя (родной брат отца)"
                    : `Дяди - родные братья отца (${formData.heirs.unclesFull})`,
                relation: "Асааба по линии отца",
                baseFraction: new Fraction(0, 1),
                finalFraction: new Fraction(0, 1),
                percentage: 0,
                amount: 0,
                dalil:
                  "Порядок асаба по мужской линии: сын → внук → отец → дед → братья → племянники → дяди",
                blocked: true,
                blockedBy: blockReason,
              });
            }

            if (formData.heirs.unclesPaternal > 0) {
              let blockReason;
              if (hasCloserAgnaticHeirs) {
                blockReason = distantAsabaBlockReason;
              } else if (formData.heirs.unclesFull > 0) {
                blockReason = "Блокируются родными дядями";
              } else {
                blockReason = "Блокируются племянниками";
              }
              results.heirs.push({
                name:
                  formData.heirs.unclesPaternal === 1
                    ? "Дядя (единокровный брат отца)"
                    : `Дяди - единокровные братья отца (${formData.heirs.unclesPaternal})`,
                relation: "Асааба по линии отца",
                baseFraction: new Fraction(0, 1),
                finalFraction: new Fraction(0, 1),
                percentage: 0,
                amount: 0,
                dalil:
                  "Порядок асаба по мужской линии: сын → внук → отец → дед → братья → племянники → дяди",
                blocked: true,
                blockedBy: blockReason,
              });
            }
          }

          // Если нет близких асаба, но есть дальние асаба по мужской линии,
          // отдаём им остаток (племянники по брату, дяди по отцу и т.д.)
          if (remainderPct > 0.0001 && formData.heirs.otherPaternalAsaba) {
            const remainderFraction = Fraction.fromDecimal(remainderPct / 100);
            results.heirs.push({
              name: "Дальние наследники по мужской линии (асаб)",
              relation: "Асааба по линии отца",
              baseFraction: remainderFraction,
              finalFraction: remainderFraction,
              percentage: remainderPct,
              amount: remainderAmount,
              dalil:
                "Порядок асаба по мужской линии: сын → внук → отец → дед → братья → племянники → дяди",
              blocked: false,
              blockedBy: null,
            });

            totalPercentage = 100;
            remainderPct = 0;
            remainderAmount = 0;
          }

          // Если остался остаток и нет особого наследника-асааба, применяем ар-Радд
          // Супруги не участвуют в Радд: остаток им не добавляется, он остаётся казне/садаке
          if (remainderPct > 0.0001) {
            const raddEligible = results.heirs.filter((heir) => {
              if (heir.blocked || (heir.percentage || 0) === 0) return false;
              const isSpouse =
                heir.name === "Муж" ||
                heir.name.startsWith("Жена") ||
                heir.name.startsWith("Жены");
              return !isSpouse;
            });

            if (raddEligible.length > 0) {
              // Сумма процентов супругов (они не участвуют в радд)
              const spousePercentage = results.heirs
                .filter((heir) => {
                  const isSpouse =
                    heir.name === "Муж" ||
                    heir.name.startsWith("Жена") ||
                    heir.name.startsWith("Жены");
                  return (
                    isSpouse && !heir.blocked && (heir.percentage || 0) > 0
                  );
                })
                .reduce((sum, heir) => sum + (heir.percentage || 0), 0);

              // Сумма процентов eligible наследников (без супругов)
              const eligiblePercentage = raddEligible.reduce(
                (sum, heir) => sum + (heir.percentage || 0),
                0
              );

              // Остаток, который нужно распределить = 100% - доля супругов
              const availableForEligible = 100 - spousePercentage;

              // Коэффициент масштабирования для eligible наследников
              const raddRatioValue =
                eligiblePercentage > 0
                  ? availableForEligible / eligiblePercentage
                  : 1;
              const raddRatioFraction = Fraction.fromDecimal(raddRatioValue);

              results.raddApplied = true;
              results.raddRecipients = raddEligible.map((heir) => heir.name);

              results.heirs = results.heirs.map((heir) => {
                if (!raddEligible.includes(heir)) return heir;

                const scaled = { ...heir };
                scaled.percentage = (heir.percentage || 0) * raddRatioValue;
                if (heir.finalFraction && heir.finalFraction.multiply) {
                  scaled.finalFraction = heir.finalFraction
                    .multiply(raddRatioFraction)
                    .simplify();
                }
                if (heir.baseFraction && heir.baseFraction.multiply) {
                  scaled.baseFraction = heir.baseFraction
                    .multiply(raddRatioFraction)
                    .simplify();
                }
                scaled.amount =
                  formData.totalEstate * (scaled.percentage / 100);
                return scaled;
              });

              totalPercentage = 100;
              remainderPct = 0;
              remainderAmount = 0;
            }
          }

          results.remainder.percentage = remainderPct;
          results.remainder.amount = remainderAmount;

          return results;
        },
      };

      // ========================================
      // Tooltip Controller
      // ========================================
      const TooltipController = {
        /**
         * Инициализация контроллера подсказок
         */
        init() {
          this.bindEvents();
          this.setupAccessibility();
        },

        /**
         * Привязка обработчиков событий
         */
        bindEvents() {
          // Обработчики для сенсорных устройств
          document.addEventListener("touchstart", (e) => {
            if (e.target.classList.contains("tooltip")) {
              this.handleTouch(e);
            }
          });

          // Обработчики для клавиатуры (доступность)
          document.addEventListener("keydown", (e) => {
            if (
              e.target.classList.contains("tooltip") &&
              (e.key === "Enter" || e.key === " ")
            ) {
              e.preventDefault();
              this.toggleTooltip(e.target);
            }
          });

          // Закрытие активных подсказок при клике вне их
          document.addEventListener("click", (e) => {
            if (!e.target.classList.contains("tooltip")) {
              this.hideAllTooltips();
            }
          });
        },

        /**
         * Настройка доступности для подсказок
         */
        setupAccessibility() {
          const tooltips = document.querySelectorAll(".tooltip");
          tooltips.forEach((tooltip) => {
            // Добавляем атрибуты для доступности
            tooltip.setAttribute("tabindex", "0");
            tooltip.setAttribute("role", "button");
            tooltip.setAttribute("aria-describedby", "tooltip-description");
            tooltip.setAttribute("aria-label", "Показать определение термина");
          });
        },

        /**
         * Обработчик касания для мобильных устройств
         * @param {TouchEvent} e - событие касания
         */
        handleTouch(e) {
          e.preventDefault();
          const tooltip = e.target;

          // Переключаем состояние подсказки
          this.toggleTooltip(tooltip);
        },

        /**
         * Переключает видимость подсказки
         * @param {HTMLElement} tooltip - элемент с подсказкой
         */
        toggleTooltip(tooltip) {
          const isActive = tooltip.classList.contains("tooltip-active");

          // Скрываем все другие подсказки
          this.hideAllTooltips();

          if (!isActive) {
            tooltip.classList.add("tooltip-active");
            // Автоматически скрываем через 5 секунд
            setTimeout(() => {
              tooltip.classList.remove("tooltip-active");
            }, 5000);
          }
        },

        /**
         * Скрывает все активные подсказки
         */
        hideAllTooltips() {
          const activeTooltips = document.querySelectorAll(".tooltip-active");
          activeTooltips.forEach((tooltip) => {
            tooltip.classList.remove("tooltip-active");
          });
        },
      };

      // ========================================
      // Mobile Utilities
      // ========================================
      const MobileUtils = {
        /**
         * Проверяет, является ли устройство мобильным
         * @returns {boolean}
         */
        isMobile() {
          return globalThis.innerWidth <= 767;
        },

        /**
         * Проверяет, является ли устройство сенсорным
         * @returns {boolean}
         */
        isTouchDevice() {
          return "ontouchstart" in globalThis || navigator.maxTouchPoints > 0;
        },

        /**
         * Обрабатывает изменение ориентации экрана
         */
        handleOrientationChange() {
          // Небольшая задержка для корректного получения новых размеров
          setTimeout(() => {
            this.adjustForOrientation();
          }, 100);
        },

        /**
         * Настраивает интерфейс под текущую ориентацию
         */
        adjustForOrientation() {
          const isLandscape = globalThis.innerWidth > globalThis.innerHeight;
          const isMobile = this.isMobile();

          if (isMobile && isLandscape) {
            // Уменьшаем отступы в альбомной ориентации
            document.documentElement.style.setProperty(
              "--container-padding",
              "0.5rem"
            );

            // Уменьшаем высоту модального окна
            const modal = document.getElementById("obligations-modal");
            if (modal) {
              modal.style.paddingTop = "0.5rem";
            }
          } else if (isMobile) {
            // Восстанавливаем обычные отступы в портретной ориентации
            document.documentElement.style.setProperty(
              "--container-padding",
              "1rem"
            );
          }
        },

        /**
         * Инициализация мобильных утилит
         */
        init() {
          // Обработчик изменения ориентации
          globalThis.addEventListener("orientationchange", () => {
            this.handleOrientationChange();
          });

          // Обработчик изменения размера окна
          globalThis.addEventListener("resize", () => {
            this.adjustForOrientation();
          });

          // Начальная настройка
          this.adjustForOrientation();

          // Предотвращаем зум при двойном тапе на iOS
          if (this.isTouchDevice()) {
            let lastTouchEnd = 0;
            document.addEventListener(
              "touchend",
              (event) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                  event.preventDefault();
                }
                lastTouchEnd = now;
              },
              false
            );
          }
        },
      };

      // ========================================
      // Initialization
      // ========================================
      // Делимся ключевыми объектами во внешней области видимости (используется в интеграционных тестах)
      globalThis.AppState = AppState;
      globalThis.FormController = FormController;
      globalThis.CalculationController = CalculationController;
      globalThis.ResultsController = ResultsController;

      document.addEventListener("DOMContentLoaded", () => {
        // Инициализация мобильных утилит
        MobileUtils.init();

        // Инициализация модального окна (Шаг 0)
        ModalController.init();

        // Инициализация контроллера формы (Шаг 1)
        FormController.init();

        // Инициализация контроллера результатов
        ResultsController.init();

        // Инициализация контроллера расчетов
        CalculationController.init();

        // Инициализация контроллера подсказок
        TooltipController.init();
      });
    </script>
    <!-- 100% privacy-first analytics -->
    <script
      async
      src="https://scripts.simpleanalyticscdn.com/latest.js"
    ></script>
  </body>
</html>
